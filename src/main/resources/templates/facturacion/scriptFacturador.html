<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<body th:fragment="scriptFacturacionFracmento" class="d-none">
    <script type="text/javascript">
    
  //Cuando cargo el documento
        $("#tipoCambio").val($("#moneda" + $("#codMoneda").val()).val());

        if (parseInt($("#codMoneda").val()) === 1) {
            $(".simbolo-moneda").text("¢");
        } else if (parseInt($("#codMoneda").val()) === 2) {
            $(".simbolo-moneda").text("$");
        }
        if (parseInt($("#codMoneda").val()) === 3) {
            $(".simbolo-moneda").text("€");
        }

        if ($("#omitirReceptor").val() == "true") {
            $("#inputBuscarClientes").prop("required", false);
        } else {
            $("#inputBuscarClientes").prop("required", true);
        }
    

        //loadingShow();
        var token = $('#csrfToken').val();
        var decimales = [(${ session.SESSION_DECIMALES })];
        var ArrayUnidadesMedida = ["Al", "Alc", "Cm", "I", "Os", "Sp", "Spe", "St", "d", "h", "s"];

        //$("#modalImprimir").modal("show");

        $(document).on("keyup", ".medioPago, .medioPagoDolar, .medioPagoEuro", function () {
            if ($(this).val() === "") {
                $(this).val("0");
            }
        });
        
        function limpiarCliente(){
            $("#exoneraTipoDocumentoExonera").val("");
        	$("#exoneraNumero").val("");
        	$("#exoneraInstitucion").val("");
        	$("#exoneraFechaEmision").val("");            	
        	$("#exoneraTipoDocumentoExonera").select2();
        }

        $(document).on("change", "#tipoDocumento", function () {
            var u = "";
            if ($(this).val() === "FEE") {
                $('input[id^="partidaArancelaria"]').each(function () {
                    u = $(this).attr("data-um");
                    if (ArrayUnidadesMedida.includes(u.trim())) {
                        $(this).prop("required", false);
                    } else {
                        $(this).prop("required", true);
                    }
                });
            }

            if ($(this).val() === "FEC") {

                $("#labelBuscarClienteProveedor").text("F6 - Buscar proveedor");

                swal({
                    title: "Mensaje informativo",
                    text: "La Factura Electrónica Compra se utiliza SOLO cuando se realizan compras al Régimen Simplificado o para el Sector Agropecuario, NO debe emitir este tipo de documento a ningún cliente.",
                    icon: "warning",
                    button: "Continuar",
                });

                agregaReferencia();

            } else {
                $("#labelBuscarClienteProveedor").text("F6 - [(#{txt.busque.el.cliente})]");
            }

            if ($(this).val() === "TE") {
                $("#omitirReceptor").val('true');
                $('#omitirReceptor').select2();
                
                $(".datos-cliente").hide();
                
                $("#inputBuscarClientes").prop("placeholder", "Tiquete electrónico no es necesario seleccionar un cliente.");
                $("#boxInputClienteContado").show();
                $("#boxInputCorreoContado").show();    
                $("#inputCorreoContado").show();                
                $(".datos-cliente").hide();                
            } else {
                $("#omitirReceptor").val('false');
                $('#omitirReceptor').select2();
                $("#inputBuscarClientes").prop("placeholder", "Digite el nombre o la identificación");
                
                $(".datos-cliente").show();
                
                $("#boxInputClienteContado").hide();
                $("#boxInputCorreoContado").hide();    
                $("#inputCorreoContado").hide();                
                $(".datos-cliente").show();
            }

        });

        $(document).on("change", "#omitirReceptor", function () {
            if ($(this).val() === "false") {
            	$(".datos-cliente").show();
                $("#inputClienteContado").val("");
                $("#boxInputClienteContado").hide();
                $("#boxInputCorreoContado").hide(); 
            } else {
            	
            	$(".datos-cliente").hide();
            	
                if ($("#tipoDocumento").val() === "TE" || $("#tipoDocumento").val() === "FEE" || $("#tipoDocumento").val() === "PR") {
                    $("#boxInputClienteContado").show();
                    $("#boxInputCorreoContado").show();     
                } else {
                    $("#boxInputClienteContado").hide();
                    $("#boxInputCorreoContado").hide();  
                }
            }
        });

        $(document).on("change", ".comboOtrosCargosTipoDoc", function () {

            var id = $(this).attr("data-id");
            var v = $(this).val();
            if (parseInt(v) === 4) {
                $("#otrosCargosIdentificacion" + id).prop("readonly", false);
                $("#otrosCargosNombre" + id).prop("readonly", false);
            } else {
                $("#otrosCargosIdentificacion" + id).prop("readonly", true);
                $("#otrosCargosNombre" + id).prop("readonly", true);
            }

        });

        function documentoAGenerar() {
            var tf = $("#tipoDocumento option:selected").text();
            $("#documentoAGenerar").text(tf);
        }

        $(window).keydown(function (e) {

            if (e.keyCode == 117) {
                $("#inputBuscarClientes").focus();
                return false;
            }

            if (e.keyCode == 118) {
                $("#inputBuscarProductos").focus();
                $("#inputBuscarProductosManual").focus();
                return false;
            }

            //console.log("teclas = " + e.keyCode);

            if (e.keyCode == 13) {
                e.preventDefault();
                return false;
            }

            if (e.keyCode == 120) {
                validarCobroVenta();
                return false;
            }

            if (e.keyCode == 115) {
                e.preventDefault();
            }

            if (e.keyCode == 121) {

                var totalPagos = 0;
                $('input[id^="medioPago"]').each(function () {
                    totalPagos += parseFloat($(this).val());
                });

                var tp = parseFloat($("#totalAPagar").val());
                if (totalPagos == "" || totalPagos == 0) {
                    return false;
                }

                $('#btnEmitirFactura').submit();
            }


        });

        $(document).on("click", "#btnModalPagar", function () {
            documentoAGenerar(); //Muestra el tipo de documento que se va a generar antes de pagar
            validarCobroVenta();
        });

        $(document).on("keyup", ".medioPago, .medioPagoDolar, .medioPagoEuro", function (e) {

            var a = $("#totalAPagar").val();
            var m = $("#codMoneda").val();

            var totalVenta = 0;
            var totalPagos = 0;
            var totalPagosColones = 0;
            var totalPagosDolares = 0;
            var totalPagosEuros = 0;

            var totalPagosColonesC = 0;
            var totalPagosDolaresC = 0;
            var totalPagosEurosC = 0;

            var vueltoC = 0;
            var vueltoD = 0;
            var vueltoE = 0;

            $('.medioPago').each(function () {
                totalPagosColones += parseFloat($(this).val());
            });
            totalPagosColonesC = totalPagosColones;
            //console.log("totalPagosColonesC " + totalPagosColonesC);

            $('.medioPagoDolar').each(function () {
                totalPagosDolares += parseFloat($(this).val());
            });
            //Convierto a colones
            totalPagosDolaresC = totalPagosDolares * parseFloat($("#moneda2").val());
            //console.log("totalPagosDolares " +totalPagosDolaresC);

            $('.medioPagoEuro').each(function () {
                totalPagosEuros += parseFloat($(this).val());
            });
            totalPagosEurosC = totalPagosEuros * parseFloat($("#moneda3").val());
            //console.log("totalPagosEurosC " +totalPagosEurosC);

            totalPagos = parseFloat(totalPagosColonesC) + parseFloat(totalPagosDolaresC) + parseFloat(totalPagosEurosC);

            //console.log("totalPagos " + totalPagos);

            //Convierto la venta en colones
            if (parseInt(m) === 1) {
                totalVenta = a;
            } else if (parseInt(m) === 2) {
                totalVenta = a * parseFloat($("#moneda2").val());
            } else {
                totalVenta = a * parseFloat($("#moneda3").val());
            }

            vueltoC = parseFloat(totalPagos) - parseFloat(totalVenta);

            vueltoD = (parseFloat(totalPagos) - parseFloat(totalVenta)) / parseFloat($("#moneda2").val());

            vueltoE = (parseFloat(totalPagos) - parseFloat(totalVenta)) / parseFloat($("#moneda3").val());


            $(".suVuelto").val(vueltoC);
            $(".suVueltoDolar").val(vueltoD);
            $(".suVueltoEuro").val(vueltoE);

            return false;
        });

        $(document).on("change", "#condVenta", function (e) {

            if (parseInt($(this).val()) === 2) {

            	//$(".condicion-venta").hide();
            	
                $('#plazoCredito').prop('readonly', false);
                $('#plazoCredito').prop('required', true);

                if (parseInt($('#plazoCredito').val()) <= 0) {
                    $('#notificacionPlazoCredito').show();
                    $('#notificacionPlazoCredito').html('Plazo de Crédito no puede ser igual a "0" o nulo.');
                } else {
                    $('#notificacionPlazoCredito').hide();
                    $('#notificacionPlazoCredito').html('');
                }

                if ($("#omitirReceptor").val() === "true") {
                    swal("Notificación", "Debe completar el receptor para poder emitir la factura a crédito", "warning");
                    //$("#condVenta").val("1");
                    //$("#condVenta").select2();
                    return false;
                }

            } else {
            	//$(".condicion-venta").show();
            	
                $('#notificacionPlazoCredito').hide();
                $('#plazoCredito').prop('readonly', true);
                $('#plazoCredito').prop('required', false);
                $('#plazoCredito').val("0");                
            }

        });

        $(document).on("input", "#plazoCredito", function (e) {

            var v = $("#condVenta").val();

            if (parseInt(v) === 2) {

                $('#plazoCredito').prop('readonly', false);
                $('#plazoCredito').prop('required', true);

                if (parseInt($('#plazoCredito').val()) <= 0) {

                    $('#notificacionPlazoCredito').show();
                    $('#notificacionPlazoCredito').html('Plazo de Crédito no puede ser igual a "0" o nulo.');

                    $("#omitirReceptor").val("false");
                    $('#inputBuscarClientes').prop('required', true);
                    $('#inputCorreoCliente').prop('required', true);

                    $("#omitirReceptor").val('true');
                    $('#omitirReceptor').select2();
                    $("#inputBuscarClientes").prop("readonly", true);
                    $("#inputCorreoCliente").prop("readonly", true);

                } else {
                    $('#notificacionPlazoCredito').hide();
                    $('#notificacionPlazoCredito').html('');

                    $('#inputBuscarClientes').prop('required', false);
                    $('#inputCorreoCliente').prop('required', false);

                    $("#omitirReceptor").val('false');
                    $('#omitirReceptor').select2();
                    $("#inputBuscarClientes").prop("placeholder", "Digite el nombre o la identificación");
                    $("#inputBuscarClientes").prop("readonly", false);
                    $("#inputCorreoCliente").prop("readonly", false);
                }

                if ($("#omitirReceptor").val() === "true") {
                    swal("Notificación", "Debe completar el receptor para poder emitir la factura a crédito", "warning");
                    $("#condVenta").val("1");
                    $("#condVenta").select2();
                    return false;
                }

            } else {
                $('#notificacionPlazoCredito').hide();
                //$('#plazoCredito').prop('readonly', true);
                $('#plazoCredito').prop('required', false);
                //$('#plazoCredito').val("0");
            }

        });

        $(document).on("change", "#omitirReceptor", function (e) {
            if ($(this).val() === "false") {
                $('#inputBuscarClientes').prop('required', true);
                $('#inputCorreoCliente').prop('required', true);
            } else {
                $('#inputBuscarClientes').prop('required', false);
                $('#inputCorreoCliente').prop('required', false);
            }
            return false;
        });

        function openInNewTab(url) {
            var win = window.open(url, '_blank');
            win.focus();
        }

        $(document).on("click", ".btn-imprimir-factura", function (e) {
            e.preventDefault();

            var t = $(this).attr("data-print");
            var urlPrint = $("#inputImprimirFactura").val() + "/?print=" + t;

            if (!isMobile.any()) {

                setTimeout(function () {

                    printJS(urlPrint);

                }, 100);

            } else {
                openInNewTab(urlPrint);
            }

        });

        $(document).on("change", "#plazoCredito", function (e) {
            if (parseInt($(this).val()) <= 0) {
                $('#notificacionPlazoCredito').show();
                $('#notificacionPlazoCredito').html('Plazo de Crédito no puede ser igual a "0" o nulo.');
            } else {
                $('#notificacionPlazoCredito').hide();
                $('#notificacionPlazoCredito').html('');
            }
        });

        function agregaReferencia() {

            var count = $("#countReferencia").val();

            if (parseInt(count) === 10) {

                swal("", "Solo se admiten hasta un máximo de 10 referencias.", "warning");

                return false
            }

            var linea = $("#itemsReferencia").html();

            linea = linea.replace(/{R_ID}/g, count);

            $("#contentWrapReferencias").append(linea);

            $('#referenciaTipoDoc' + count).select2();
            $('#referenciaCodigoDocumento' + count).select2();

            $("#countReferencia").val(parseInt(count) + 1);

            $('#referenciaFechaDeEmision' + count).datepicker({
                autoclose: true,
                format: 'dd/mm/yyyy',
                todayHighlight: true
            });
        }

        $(document).on("click", "#btnAgregarReferencia", function (e) {

            e.preventDefault();

            agregaReferencia();

        });


        $(document).on("click", ".deleteReferencia", function (e) {

            e.preventDefault();

            var count = $("#countReferencia").val();

            $("#referencia" + $(this).attr("data-id")).remove();

            $("#countReferencia").val(parseInt(count) - 1);

        });

        $(document).on("click", "#btnAgregarOtrosCargos", function (e) {

            e.preventDefault();

            var count = $("#countOtrosCargos").val();

            if (parseInt(count) === 15) {

                swal("", "Solo se admiten hasta un máximo de 15 cargos.", "warning");

                return false
            }

            var linea = $("#itemsOtrosCargos").html();

            linea = linea.replace(/{R_ID}/g, count);

            $("#contentWrapOtrosCargos").append(linea);

            $('#otrosCargosTipoDoc' + count).select2();

            $("#countOtrosCargos").val(parseInt(count) + 1);


        });

        $(document).on("click", ".deleteOtrosCargos", function (e) {

            e.preventDefault();

            var count = $("#countOtrosCargos").val();

            $("#otrosCargos" + $(this).attr("data-id")).remove();

            $("#countOtrosCargos").val(parseInt(count) - 1);

        });

        $(document).on("keyup", "#medioPago2", function (e) {

            e.preventDefault();

            if (parseFloat($(this).val()) > 0) {
                $(".medio-pago-tarjeta").show();
                $(".input-medio-pago-tarjeta").prop('required', true);
            } else {
                $(".medio-pago-tarjeta").hide();
                $(".input-medio-pago-tarjeta").prop('required', false);
            }

        });

        $(document).on("keyup", "#medioPagoDolar2", function (e) {

            e.preventDefault();

            if (parseFloat($(this).val()) > 0) {
                $(".medio-pago-tarjeta-dolar").show();
                $(".input-medio-pago-tarjeta-dolar").prop('required', true);
            } else {
                $(".medio-pago-tarjeta-dolar").hide();
                $(".input-medio-pago-tarjeta-dolar").prop('required', false);
            }

        });

        $(document).on("keyup", "#medioPagoEuro2", function (e) {

            e.preventDefault();

            if (parseFloat($(this).val()) > 0) {
                $(".medio-pago-tarjeta-euro").show();
                $(".input-medio-pago-tarjeta-euro").prop('required', true);
            } else {
                $(".medio-pago-tarjeta-euro").hide();
                $(".input-medio-pago-tarjeta-euro").prop('required', false);
            }

        });

        $("#inputBuscarClientes").autocomplete({
            source: function (request, response) {
                $.ajax({
                    url: "[(@{/proformas/buscar-clientes/})]" + request.term,
                    dataType: "json",
                    beforeSend: function () {
                        loadingShow();
                    },
                    data: {
                        term: request.term,
                        td: $("#tipoDocumento").val()
                    },
                    success: function (data) {
                        response($.map(data, function (item) {
                            return {
                                value: 'Id: ' + item.identificacion + ', Nombre: ' + item.nombreCompleto,
                                valuePrincipal: item.id,
                                tipoIdentificacion: item.tipoDeIdentificacion.id,
                                label: 'Id: ' + item.identificacion + ', Nombre: ' + item.nombreCompleto,
                                correo: item.correo1,
                                
                                tipoDocumentoExoneracionOAutorizacion: item.tipoExoneracion,
                                numeroDocumento: item.numeroDocumento,
                                nombreInstitucion: item.nombreInstitucion,
                                porcentajeExoneracion: item.porcentajeExoneracion,
                                fechaInicioExoneracion: item.fechaInicioExoneracion,                                
                                estadoCredito: item.estadoCredito,
                                diasCredito: item.diasCredito,
                                verificarFechaFinExoneracion: item.verificarFechaFinExoneracion,                                
                            };
                        }));
                    },
                    complete: function () {
                        loadingHide();
                    }
                });
            },
            //autoFocus:true, No aplica para los cliente
            delay: 0,
            focus: function (event, ui) {
            	
                event.preventDefault();
                
                limpiarCliente();
                
                $("#inputBuscarClientes").val(ui.item.value);
                $("#inputClientesHidden").val(ui.item.valuePrincipal);
                $("#inputClientesTipoIdentificacionHidden").val(ui.item.tipoIdentificacion);
                $("#inputCorreoCliente").val(ui.item.correo);
                
              	//Datos de exoneración
                $("#exoneraTipoDocumentoExonera").val( ui.item.tipoDocumentoExoneracionOAutorizacion );
            	$("#exoneraNumero").val( ui.item.numeroDocumento );
            	$("#exoneraInstitucion").val( ui.item.nombreInstitucion );
            	//$("#").val( ui.item.porcentajeExoneracion );
            	$("#exoneraFechaEmision").val( ui.item.fechaInicioExoneracion ); 
            	
            	$("#exoneraTipoDocumentoExonera").select2();
                
                if(ui.item.verificarFechaFinExoneracion=="N"){
                	swal("Notificación", "Los datos de exoneración ya caducaron, debe actualizar los datos del cliente.", "warning");
                	limpiarCliente();
                }

            	//Datos crédito
            	if(ui.item.estadoCredito == "A"){ 
            		$("#condVenta").val( "2" );
            		$("#plazoCredito").val( ui.item.diasCredito ); 
            		$("#plazoCredito").prop("readonly", false);
            	}else{
            		$("#condVenta").val( 1 );
            		$("#plazoCredito").val( 0 );
            	}
            	
            	$("#condVenta").select2();
   
            }

        });

        $(document).on("keyup", "#inputBuscarClientes", function () {
            if ($(this).val() === "") {
                $("#inputBuscarClientes").val("");
                $("#inputClientesHidden").val("");
                $("#inputClientesTipoIdentificacionHidden").val("");
                $("#inputCorreoCliente").val("");
            }
        });


        $("#inputBuscarProductos").on("input", function (e) {
            var inventarioActual = "";
            $(window).keydown(function (e) {
                if (e.keyCode == 13) {

                    var search = $("#inputBuscarProductos").val().trim();
                    $("#inputBuscarProductos").val("");

                    if (search.length == 0) {
                        return false;
                    }


                    $.ajax({
                        type: "GET",
                        cache: false,
                        url: "[(@{/proformas/buscar-productos/})]" + search,
                        beforeSend: function () {
                            loadingShow();
                        },
                        dataType: "json",
                        data: {
                            term: search,
                            _csrf: token,
                            b: "a"
                        },
                        success: function (data) {

                            $(data).each(function (key, item) {

                                var monedaProducto = parseInt(item.moneda.id);
                                var codMoneda = parseInt($("#codMoneda").val());
                                var tipoCambio = $("#tipoCambio").val();
                                var precio = parseFloat(0.00);
                                var precioFinal = parseFloat(0.00);
                                var conversionImpuesto = parseFloat(0.00);
                                var precioFraccion = parseFloat(item.precioFraccion);
                                var fraccionesPorUnidad = item.fraccionesPorUnidad;
                                var tipoVenta = item.tipoVenta;
                                var aplicaDevolucionIva = item.aplicaDevolucionIva;
                                var utilidadFraccion    = item.utilidadFraccion;

                                if (monedaProducto === codMoneda) {
                                    precio = parseFloat(item.precio);
                                    precioFraccion = toFixed(parseFloat(precioFraccion), decimales);
                                    conversionImpuesto = parseFloat(item.impuestoTotal);
                                } else {

                                    if (item.moneda.simboloMoneda === "CRC") {

                                        if (codMoneda === 1) {
                                            precio = toFixed(parseFloat(item.precio), decimales);
                                            precioFraccion = toFixed(parseFloat(item.precioFraccion), decimales);
                                            conversionImpuesto = toFixed(parseFloat(item.impuestoTotal), decimales);
                                        } else if (codMoneda === 2) {
                                            precio = toFixed(parseFloat(item.precio), decimales) / toFixed(parseFloat($("#moneda2").val()), decimales);
                                            precioFraccion = toFixed(parseFloat(item.precioFraccion), decimales) / toFixed(parseFloat($("#moneda2").val()), decimales);
                                            conversionImpuesto = toFixed(parseFloat(item.impuestoTotal), decimales) / toFixed(parseFloat($("#moneda2").val()), decimales);
                                        } else {
                                            precio = toFixed(parseFloat(item.precio), decimales) / toFixed(parseFloat($("#moneda3").val()), decimales);
                                            precioFraccion = toFixed(parseFloat(item.precioFraccion), decimales) / toFixed(parseFloat($("#moneda3").val()), decimales);
                                            conversionImpuesto = toFixed(parseFloat(item.impuestoTotal), decimales) / toFixed(parseFloat($("#moneda3").val()), decimales);
                                        }

                                    } else if (item.moneda.simboloMoneda === "USD") {

                                        if (codMoneda === 1) {
                                            precio = toFixed(parseFloat(item.precio), decimales) * toFixed(parseFloat($("#moneda2").val()), decimales);
                                            precioFraccion = toFixed(parseFloat(item.precioFraccion), decimales) * toFixed(parseFloat($("#moneda2").val()), decimales);
                                            conversionImpuesto = toFixed(parseFloat(item.impuestoTotal), decimales) * toFixed(parseFloat($("#moneda2").val()), decimales);
                                        } else if (codMoneda === 2) {
                                            precio = toFixed(parseFloat(item.precio), decimales);
                                            precioFraccion = toFixed(parseFloat(item.precioFraccion), decimales);
                                            conversionImpuesto = toFixed(parseFloat(item.impuestoTotal), decimales);
                                        } else {
                                            precio = toFixed(parseFloat(item.precio), decimales) * toFixed(parseFloat($("#moneda2").val()), decimales) / toFixed(parseFloat($("#moneda3").val()), decimales);
                                            precioFraccion = toFixed(parseFloat(item.precioFraccion), decimales) * toFixed(parseFloat($("#moneda2").val()), decimales) / toFixed(parseFloat($("#moneda3").val()), decimales);
                                            conversionImpuesto = toFixed(parseFloat(item.impuestoTotal), decimales) * toFixed(parseFloat($("#moneda2").val()), decimales) / toFixed(parseFloat($("#moneda3").val()), decimales);
                                        }

                                    } else if (item.moneda.simboloMoneda === "EUR") {

                                        if (codMoneda === 1) {
                                            precio = toFixed(parseFloat(item.precio), decimales) * toFixed(parseFloat($("#moneda3").val()), decimales);
                                            precioFraccion = toFixed(parseFloat(item.precioFraccion), decimales) * toFixed(parseFloat($("#moneda3").val()), decimales);
                                            conversionImpuesto = toFixed(parseFloat(item.impuestoTotal), decimales) * toFixed(parseFloat($("#moneda3").val()), decimales);
                                        } else if (codMoneda === 2) {
                                            precio = toFixed(parseFloat(item.precio), decimales) * toFixed(parseFloat($("#moneda3").val()), decimales) / toFixed(parseFloat($("#moneda2").val()), decimales);
                                            precioFraccion = toFixed(parseFloat(item.precioFraccion), decimales) * toFixed(parseFloat($("#moneda3").val()), decimales) / toFixed(parseFloat($("#moneda2").val()), decimales);
                                            conversionImpuesto = toFixed(parseFloat(item.impuestoTotal), decimales) * toFixed(parseFloat($("#moneda3").val()), decimales) / toFixed(parseFloat($("#moneda2").val()), decimales);
                                        } else {
                                            precio = toFixed(parseFloat(item.precio), decimales);
                                            precioFraccion = toFixed(parseFloat(item.precioFraccion), decimales);
                                            conversionImpuesto = toFixed(parseFloat(item.impuestoTotal), decimales);
                                        }

                                    }

                                }

                                if (item.afectaInventario == 1) {
                                    inventarioActual = ", Inventario actual: " + toFixed(item.inventarioActual, decimales);
                                }

                                //console.log("impuesto del producto: " + item.impuestoTotal);

                                precioFinal = toFixed(parseFloat(precio + conversionImpuesto), decimales);

                                var value = 'Código: ' + item.codigo + ', Producto: ' + item.nombreProducto + ', Precio: ' + item.moneda.simboloMoneda + ' ' + toFixed(precioFinal, decimales) + inventarioActual;
                                var valuePrincipal = item.id;
                                var codigo = item.codigo;
                                var label = 'Código: ' + item.codigo + ', Producto: ' + item.nombreProducto + ', Precio: ' + item.moneda.simboloMoneda + ' ' + toFixed(precioFinal, decimales) + inventarioActual;

                                if ("[(${V_FACTURADOR})]" === "V1") {
                                    precioFinal = toFixed(parseFloat(precio), decimales);
                                }

                                var codigo1 = item.tipoProducto.id;
                                var codigo2 = item.codigo;
                                var producto = item.nombreProducto;
                                var precio = precioFinal;
                                var impuesto = toFixed(parseFloat(item.impuestoTotal), decimales);
                                var impuestoTarifaIva = item.productoImpuesto;
                                var unidadDeMedida = item.unidadDeMedida.simbolo;
                                var impuestosExoneracion = item.productoImpuesto;
                                var productoExento = item.productoExento;
                                var precioConIva = precioFinal;

                                if (itemsHelper.hasProducto(valuePrincipal)) {

                                    itemsHelper.incrementaCantidad(valuePrincipal, precioFinal, impuesto, productoExento, 1, 0, unidadDeMedida);
                                    $("#inputBuscarProductos").val("");
                                    $("#inputBuscarProductosManual").val("");
                                    return false;
                                }

                                var linea = $("#plantillaItemsFactura").html();
                                var imp = item.impuestoTotal;
                                if (typeof imp !== 'undefined') {
                                    imp = item.impuestoTotal;
                                } else {
                                    imp = 0;
                                }

                                linea = linea.replace(/{ID}/g, valuePrincipal);
                                linea = linea.replace(/{CODIGO}/g, codigo);
                                linea = linea.replace(/{CODIGO_PRODUCTO1}/g, codigo1);
                                linea = linea.replace(/{CODIGO_PRODUCTO2}/g, codigo2);
                                linea = linea.replace(/{NOMBRE_PRODUCTO}/g, producto);
                                linea = linea.replace(/{PRECIO_COMPRA}/g, item.precioCompra);
                                linea = linea.replace(/{UTILIDAD}/g, item.utilidad);
                                linea = linea.replace(/{PRECIO_PROMEDIADO}/g, item.precioPromediado);
                                linea = linea.replace(/{PRECIO}/g, toFixed(precioFinal, decimales));                                
                                linea = linea.replace(/{PRECIO_FRACCION}/g, toFixed(precioFraccion, decimales));  
                                
                                console.log(" toFixed(precioFraccion, decimales)toFixed(precioFraccion, decimales) " + toFixed(precioFraccion, decimales));

                                var utilidadDecimal = 0.00;
                                try{
                                	
                                	if(utilidadFraccion >= 10){
                                		utilidadDecimal = parseFloat('1.'+utilidadFraccion);
                                	}else{
                                		utilidadDecimal = parseFloat('0.0'+utilidadFraccion);
                                	}
                                	
                                }catch(error){
                                	utilidadDecimal = utilidadDecimal;
                                }

                                
                                linea = linea.replace(/{UTILIDAD_FRACCION}/g, toFixed(utilidadFraccion, decimales));  
                                linea = linea.replace(/{PRECIO_VENTA_FRACCION}/g, toFixed(  ((parseFloat(precioFinal) / parseFloat(fraccionesPorUnidad))) + ((parseFloat(precioFinal) / parseFloat(fraccionesPorUnidad)) * utilidadDecimal), decimales));  
                                
                                linea = linea.replace(/{IMPUESTO}/g, imp);
                                linea = linea.replace(/{CONDICION_PRODUCTO}/g, productoExento);
                                linea = linea.replace(/{UNIDAD_DE_MEDIDA}/g, unidadDeMedida);
                                linea = linea.replace(/{DESC_ID}/g, $("#descuento_" + valuePrincipal).val());
                                linea = linea.replace(/{MONEDA}/g, codMoneda);
                                linea = linea.replace(/{INVENTARIO_ACTUAL}/g, item.inventarioActual);
                                $("#cargarItemProductos #loadLineasFactura").prepend(linea);

                                var filasImpuestos = "";

                                //Si el producto es exento no debe incluir impuestos
                                if (parseInt(productoExento) === 2) {

                                } else {
                                    $(impuestosExoneracion).each(function (key, value) {

                                        filasImpuestos += '<tr>';
                                        filasImpuestos += '<td><input id="_impuestoTarifaIva' + valuePrincipal + value.codigosTarifasIva.id + '" name="impuestoTarifaIva'+ valuePrincipal +'[]" type="hidden" value="0' + value.codigosTarifasIva.id + '" /><input readonly="readonly" class="form-control" type="text" id="_impuestosDetalle' + valuePrincipal + value.impuesto.id + '" name="impuestosDetalle[]" value="' + value.impuesto.detalleImpuesto + '" readonly="readonly" /></td>';
                                        filasImpuestos += '<td><input type="hidden" id="impuestosId' + valuePrincipal + '" name="impuestosId' + valuePrincipal + '[]" value="' + value.impuesto.id + '" /><input readonly="readonly" id="exonera1' + valuePrincipal + value.impuesto.id + '" type="text" name="Impuestoimpuestos' + valuePrincipal + '[]" value="' + value.porcentaje + '" data-i="' + value.porcentaje + '" class="form-control align-right" /></td>';
                                        filasImpuestos += '<td><input readonly="readonly" name="impuestosMonto' + valuePrincipal + '[]" id="exonera2' + valuePrincipal + value.impuesto.id + '" type="text" value="0" class="form-control align-right number-format exonera2' + valuePrincipal + ' " data-tarifa="' + value.porcentaje + '"  /></td>';
                                        filasImpuestos += '<td><input name="exoneraCheckBox' + valuePrincipal + '[]" id="checkBoxExonera' + valuePrincipal + value.impuesto.id + '" class="form-control" type="checkbox" onChange="exoneraChange(' + value.impuesto.id + ',' + value.porcentaje + ',' + productoExento + ',' + valuePrincipal + ')" class="align-center" /></td>';
                                        filasImpuestos += '<td><input data-producto="'+valuePrincipal+'" onclick="return this.select();" value="0" maxlength="3" name="exoneraPorcentajeExoneracion' + valuePrincipal + '[]" data-iva-id="' + value.impuesto.id + '" id="exonera3' + valuePrincipal + value.impuesto.id + '" onKeyup="exoneraKeyUp(' + value.impuesto.id + ',' + value.porcentaje + ',' + valuePrincipal + ',this.value)" type="text" class="form-control align-right num-integer input-exoneracion" /></td>';
                                        filasImpuestos += '<td><input value="0" name="montoExoneracion' + valuePrincipal + '[]" readonly="readonly" id="exonera4' + valuePrincipal + value.impuesto.id + '" type="text" class="form-control number-format align-right" /></td>';
                                        filasImpuestos += '<td class="text-center"><button id="btn-change-impuesto' + valuePrincipal + value.impuesto.id + value.codigosTarifasIva.id + '" data-p=' + valuePrincipal + ' data-i=' + value.impuesto.id + ' data-t=' + value.codigosTarifasIva.id + ' class="btn-change-impuesto btn btn-xs btn-success" data-toggle="modal" data-target=".modalImpuestos"><i class="fas fa-edit"></i> Modificar impuesto</button></td>';
                                        filasImpuestos += '</tr>';
                                    });

                                    $("#gridImpuestos" + valuePrincipal).append(filasImpuestos);
                                }

                                $("#fraccionesPorUnidad_" + valuePrincipal).val(fraccionesPorUnidad);
                                $("#tipoVenta_" + valuePrincipal).val(tipoVenta);

                                if(tipoVenta == "U"){
                                    $("#fraccion_" + valuePrincipal +", #precioFraccion_"+ valuePrincipal).prop("readonly", true);
                                }
                                
                                if(item.aplicaDevolucionIva == "S"){
                                	$("#impuesto_total_" + valuePrincipal).attr("data-diva", "S");
                                }else{
                                	$("#impuesto_total_" + valuePrincipal).attr("data-diva", "N");
                                }

                                itemsHelper.calcularImporte(valuePrincipal, precioFinal, impuesto, productoExento, 1, 0, unidadDeMedida);
                                $("#inputBuscarProductos").val("");
                            });

                            var count = Object.keys(data).length;
                            //console.log("Datos obtenidos: " + count);

                            if (parseInt(count) === 0) {
                                alert("No se encontro el producto");
                                $("#inputBuscarProductos").focus();
                            }

                        },
                        complete: function () {
                            loadingHide();
                        }
                    });

                }
            });
        });


        $("#inputBuscarProductosManual").autocomplete({

            source: function (request, response) {
                var inventarioActual = "";

                $.ajax({
                    url: "[(@{/proformas/buscar-productos/})]" + request.term,
                    beforeSend: function () {
                        loadingShow();
                    },
                    dataType: "json",
                    data: {
                        term: request.term
                    },
                    success: function (data) {

                        response($.map(data, function (item) {

                            var monedaProducto = parseInt(item.moneda.id);
                            var codMoneda = parseInt($("#codMoneda").val());
                            var tipoCambio = $("#tipoCambio").val();
                            var precio = parseFloat(0.00);
                            var precioFinal = parseFloat(0.00);
                            var precioFraccion = parseFloat(0.00);
                            var conversionImpuesto = parseFloat(0.00);
                            var simboloMoneda = "";
                            var precioFraccion = parseFloat(item.precioFraccion);
                            var fraccionesPorUnidad = item.fraccionesPorUnidad;
                            var tipoVenta = item.tipoVenta;

                            if (monedaProducto === codMoneda) {
                                precio = parseFloat(item.precio);
                                conversionImpuesto = parseFloat(item.impuestoTotal);
                            } else {

                                if (item.moneda.simboloMoneda === "CRC") {

                                    if (codMoneda === 1) {
                                        precio = toFixed(parseFloat(item.precio), decimales);
                                        precioFraccion = toFixed(parseFloat(item.precioFraccion), decimales);
                                        conversionImpuesto = toFixed(parseFloat(item.impuestoTotal), decimales);
                                    } else if (codMoneda === 2) {
                                        precio = toFixed(parseFloat(item.precio), decimales) / toFixed(parseFloat($("#moneda2").val()), decimales);
                                        precioFraccion = toFixed(parseFloat(item.precioFraccion), decimales) / toFixed(parseFloat($("#moneda2").val()), decimales);
                                        conversionImpuesto = toFixed(parseFloat(item.impuestoTotal), decimales) / toFixed(parseFloat($("#moneda2").val()), decimales);
                                    } else {
                                        precio = toFixed(parseFloat(item.precio), decimales) / toFixed(parseFloat($("#moneda3").val()), decimales);
                                        precioFraccion = toFixed(parseFloat(item.precioFraccion), decimales) / toFixed(parseFloat($("#moneda3").val()), decimales);
                                        conversionImpuesto = toFixed(parseFloat(item.impuestoTotal), decimales) / toFixed(parseFloat($("#moneda3").val()), decimales);
                                    }

                                } else if (item.moneda.simboloMoneda === "USD") {

                                    if (codMoneda === 1) {
                                        precio = toFixed(parseFloat(item.precio), decimales) * toFixed(parseFloat($("#moneda2").val()), decimales);
                                        precioFraccion = toFixed(parseFloat(item.precioFraccion), decimales) * toFixed(parseFloat($("#moneda2").val()), decimales);
                                        conversionImpuesto = toFixed(parseFloat(item.impuestoTotal), decimales) * toFixed(parseFloat($("#moneda2").val()), decimales);
                                    } else if (codMoneda === 2) {
                                        precio = toFixed(parseFloat(item.precio), decimales);
                                        precioFraccion = toFixed(parseFloat(item.precioFraccion), decimales);
                                        conversionImpuesto = toFixed(parseFloat(item.impuestoTotal), decimales);
                                    } else {
                                        precio = toFixed(parseFloat(item.precio), decimales) * toFixed(parseFloat($("#moneda2").val()), decimales) / toFixed(parseFloat($("#moneda3").val()), decimales);
                                        precioFraccion = toFixed(parseFloat(item.precioFraccion), decimales) * toFixed(parseFloat($("#moneda2").val()), decimales) / toFixed(parseFloat($("#moneda3").val()), decimales);
                                        conversionImpuesto = toFixed(parseFloat(item.impuestoTotal), decimales) * toFixed(parseFloat($("#moneda2").val()), decimales) / toFixed(parseFloat($("#moneda3").val()), decimales);
                                    }

                                } else if (item.moneda.simboloMoneda === "EUR") {

                                    if (codMoneda === 1) {
                                        precio = toFixed(parseFloat(item.precio), decimales) * toFixed(parseFloat($("#moneda3").val()), decimales);
                                        precioFraccion = toFixed(parseFloat(item.precioFraccion), decimales) * toFixed(parseFloat($("#moneda3").val()), decimales);
                                        conversionImpuesto = toFixed(parseFloat(item.impuestoTotal), decimales) * toFixed(parseFloat($("#moneda3").val()), decimales);
                                    } else if (codMoneda === 2) {
                                        precio = toFixed(parseFloat(item.precio), decimales) * toFixed(parseFloat($("#moneda3").val()), decimales) / toFixed(parseFloat($("#moneda2").val()), decimales);
                                        precioFraccion = toFixed(parseFloat(item.precioFraccion), decimales) * toFixed(parseFloat($("#moneda3").val()), decimales) / toFixed(parseFloat($("#moneda2").val()), decimales);
                                        conversionImpuesto = toFixed(parseFloat(item.impuestoTotal), decimales) * toFixed(parseFloat($("#moneda3").val()), decimales) / toFixed(parseFloat($("#moneda2").val()), decimales);
                                    } else {
                                        precio = toFixed(parseFloat(item.precio), decimales);
                                        precioFraccion = toFixed(parseFloat(item.precioFraccion), decimales);
                                        conversionImpuesto = toFixed(parseFloat(item.impuestoTotal), decimales);
                                    }

                                }

                            }

                            if (codMoneda == 1) {
                                simboloMoneda = "₡";
                            } else if (codMoneda == 2) {
                                simboloMoneda = "$";
                            } else {
                                simboloMoneda = "€";
                            }

                            if (item.afectaInventario == 1) {

                                console.log("item.tipoVenta  " + item.tipoVenta );
                                if(item.tipoVenta == "F"){
                                    inventarioActual = ", Inventario unidades: " + toFixed(parseFloat(item.inventarioActual) / item.fraccionesPorUnidad, decimales) + ", fracciones: " + toFixed(parseFloat(item.inventarioActual), decimales);
                                }else{
                                    inventarioActual = ", Inventario actual: " + toFixed(item.inventarioActual, decimales);
                                }

                            }

                            precioFinal = precio + conversionImpuesto;
                            precioConIva = precio + conversionImpuesto;

                            if ("[(${V_FACTURADOR})]" === "V1") {
                                precioFinal = toFixed(parseFloat(precio), decimales);
                            }

                            return {
                                value: 'Código: ' + item.codigo + ', Producto: ' + item.nombreProducto + ', Precio: ' + simboloMoneda + '' + toFixed(precioConIva, decimales) + inventarioActual,
                                valuePrincipal: item.id,
                                codigo: item.codigo,
                                label: 'Código: ' + item.codigo + ', Producto: ' + item.nombreProducto + ', Precio: ' + simboloMoneda + '' + toFixed(precioConIva, decimales) + inventarioActual,
                                codigo1: item.tipoProducto.id,
                                codigo2: item.codigo,
                                producto: item.nombreProducto,
                                precio: precioFinal,
                                fraccionesPorUnidad: item.fraccionesPorUnidad,
                                tipoVenta: item.tipoVenta,
                                precioFraccion: toFixed(parseFloat(precioFraccion), decimales),
                                precioCompra: toFixed(parseFloat(item.precioCompra), decimales),
                                precioPromediado: toFixed(parseFloat(item.precioPromediado), decimales),
                                inventarioActual: toFixed(item.inventarioActual, decimales),
                                utilidad: toFixed(item.utilidad, decimales),
                                impuesto: toFixed(parseFloat(item.impuestoTotal), decimales),
                                impuestoTarifaIva: item.productoImpuesto,
                                unidadDeMedida: item.unidadDeMedida.simbolo,
                                impuestosExoneracion: item.productoImpuesto,
                                productoExento: item.productoExento,
                                precioConIva: precioConIva,
                                monedaId: codMoneda,
                                aplicaDevolucionIva: item.aplicaDevolucionIva,
                                utilidadFraccion: item.utilidadFraccion,
                            };

                        }));
                    },
                    complete: function () {
                        loadingHide();
                    }
                });
            },
            autoFocus: true,
            delay: 0,
            select: function (event, ui) {

                event.preventDefault();

                if (itemsHelper.hasProducto(ui.item.valuePrincipal)) {
                    var precio = toFixed(parseFloat($("#precio_" + ui.item.valuePrincipal).val()), decimales);

                    //console.log("impuesto del producto ___ 2: " + ui.item.impuesto);

                    itemsHelper.incrementaCantidad(ui.item.valuePrincipal, ui.item.precio, ui.item.impuesto, ui.item.productoExento, 1, 0, ui.item.unidadDeMedida);
                    $("#inputBuscarProductos").val("");
                    $("#inputBuscarProductosManual").val("");
                    return false;
                }

                var linea = $("#plantillaItemsFactura").html();

                //console.log("impuesto del producto ___ 3: " + imp);

                var imp = ui.item.impuestoTotal;
                if (typeof imp !== 'undefined') {
                    imp = ui.item.impuestoTotal;
                } else {
                    imp = 0;
                }

                //console.log("impuesto del producto ___ 4: " + imp);

                linea = linea.replace(/{ID}/g, ui.item.valuePrincipal);
                linea = linea.replace(/{CODIGO}/g, ui.item.codigo);
                linea = linea.replace(/{CODIGO_PRODUCTO1}/g, ui.item.codigo1);
                linea = linea.replace(/{CODIGO_PRODUCTO2}/g, ui.item.codigo2);
                linea = linea.replace(/{NOMBRE_PRODUCTO}/g, ui.item.producto);
                linea = linea.replace(/{PRECIO_COMPRA}/g, ui.item.precioCompra);
                linea = linea.replace(/{UTILIDAD}/g, ui.item.utilidad);
                linea = linea.replace(/{PRECIO_PROMEDIADO}/g, ui.item.precioPromediado);
                linea = linea.replace(/{PRECIO}/g, toFixed(ui.item.precio, decimales));
                linea = linea.replace(/{PRECIO_FRACCION}/g, toFixed(ui.item.precioFraccion, decimales)); 
                
                var utilidadDecimal = 0.00;
                try{
                	
                	if(ui.item.utilidadFraccion >= 10){
                		utilidadDecimal = parseFloat('1.'+ui.item.utilidadFraccion);
                	}else{
                		utilidadDecimal = parseFloat('0.0'+ui.item.utilidadFraccion);
                	}
                	
                }catch(error){
                	utilidadDecimal = utilidadDecimal;
                }

                
                linea = linea.replace(/{UTILIDAD_FRACCION}/g, toFixed(ui.item.utilidadFraccion, decimales));  
                linea = linea.replace(/{PRECIO_VENTA_FRACCION}/g, toFixed(  ((parseFloat(ui.item.precio) / parseFloat(ui.item.fraccionesPorUnidad))) + ((parseFloat(ui.item.precio) / parseFloat(ui.item.fraccionesPorUnidad)) * utilidadDecimal), decimales));  
                
                linea = linea.replace(/{IMPUESTO}/g, imp);
                linea = linea.replace(/{CONDICION_PRODUCTO}/g, ui.item.productoExento);
                linea = linea.replace(/{UNIDAD_DE_MEDIDA}/g, ui.item.unidadDeMedida);
                linea = linea.replace(/{DESC_ID}/g, $("#descuento_" + ui.item.valuePrincipal).val());
                linea = linea.replace(/{MONEDA}/g, ui.item.monedaId);
                linea = linea.replace(/{INVENTARIO_ACTUAL}/g, ui.item.inventarioActual);

                $("#cargarItemProductos #loadLineasFactura").prepend(linea);

                var filasImpuestos = "";

                //Si el producto es exento no debe incluir impuestos
                if (parseInt(ui.item.productoExento) === 2) {

                } else {
                    $(ui.item.impuestosExoneracion).each(function (key, value) {

                        filasImpuestos += '<tr>';
                        filasImpuestos += '<td><input id="_impuestoTarifaIva' + ui.item.valuePrincipal + value.codigosTarifasIva.id + '" name="impuestoTarifaIva'+ ui.item.valuePrincipal +'[]" type="hidden" value="0' + value.codigosTarifasIva.id + '" /><input readonly="readonly" class="form-control" type="text" id="_impuestosDetalle' + ui.item.valuePrincipal + value.impuesto.id + '" name="impuestosDetalle[]" value="' + value.impuesto.detalleImpuesto + '" readonly="readonly" /></td>';
                        filasImpuestos += '<td><input type="hidden" id="impuestosId' + ui.item.valuePrincipal + '" name="impuestosId' + ui.item.valuePrincipal + '[]" value="' + value.impuesto.id + '" /><input readonly="readonly" id="exonera1' + ui.item.valuePrincipal + value.impuesto.id + '" type="text" name="Impuestoimpuestos' + ui.item.valuePrincipal + '[]" value="' + value.porcentaje + '" data-i="' + value.porcentaje + '" class="form-control align-right" /></td>';
                        filasImpuestos += '<td><input readonly="readonly" name="impuestosMonto' + ui.item.valuePrincipal + '[]" id="exonera2' + ui.item.valuePrincipal + value.impuesto.id + '" type="text" value="0" class="form-control align-right number-format exonera2' + ui.item.valuePrincipal + ' " data-tarifa="' + value.porcentaje + '"  /></td>';
                        filasImpuestos += '<td><input name="exoneraCheckBox' + ui.item.valuePrincipal + '[]" id="checkBoxExonera' + ui.item.valuePrincipal + value.impuesto.id + '" class="form-control" type="checkbox" onChange="exoneraChange(' + value.impuesto.id + ',' + value.porcentaje + ',' + ui.item.productoExento + ',' + ui.item.valuePrincipal + ')" class="align-center" /></td>';
                        filasImpuestos += '<td><input data-producto="'+ui.item.valuePrincipal+'" onclick="return this.select();" value="0" maxlength="3" name="exoneraPorcentajeExoneracion' + ui.item.valuePrincipal + '[]" data-iva-id="' + value.impuesto.id + '" id="exonera3' + ui.item.valuePrincipal + value.impuesto.id + '" onKeyup="exoneraKeyUp(' + value.impuesto.id + ',' + value.porcentaje + ',' + ui.item.valuePrincipal + ',this.value)" type="text" class="form-control align-right input-exoneracion num-integer" /></td>';
                        filasImpuestos += '<td><input value="0" name="montoExoneracion' + ui.item.valuePrincipal + '[]" readonly="readonly" id="exonera4' + ui.item.valuePrincipal + value.impuesto.id + '" type="text" class="form-control number-format align-right" /></td>';
                        filasImpuestos += '<td class="text-center"><button id="btn-change-impuesto' + ui.item.valuePrincipal + value.impuesto.id + value.codigosTarifasIva.id + '" data-p=' + ui.item.valuePrincipal + ' data-i=' + value.impuesto.id + ' data-t=' + value.codigosTarifasIva.id + ' class="btn-change-impuesto btn btn-xs btn-success" data-toggle="modal" data-target=".modalImpuestos"><i class="fas fa-edit"></i> Modificar impuesto</button></td>';
                        filasImpuestos += '</tr>';

                    });

                    $("#gridImpuestos" + ui.item.valuePrincipal).append(filasImpuestos);
                }
                
                $("#fraccionesPorUnidad_" + ui.item.valuePrincipal).val(ui.item.fraccionesPorUnidad);
                $("#tipoVenta_" + ui.item.valuePrincipal).val(ui.item.tipoVenta);

                if(ui.item.tipoVenta == "U"){
                    $("#fraccion_" + ui.item.valuePrincipal +", #precioFraccion_"+ ui.item.valuePrincipal).prop("readonly", true);
                }
                
                if(ui.item.aplicaDevolucionIva == "S"){
                	$("#impuesto_total_" + ui.item.valuePrincipal).attr("data-diva", "S");
                }else{
                	$("#impuesto_total_" + ui.item.valuePrincipal).attr("data-diva", "N");
                }

                itemsHelper.calcularImporte(ui.item.valuePrincipal, ui.item.precio, ui.item.impuesto, ui.item.productoExento, 1, 0, ui.item.unidadDeMedida);

                $("#inputBuscarProductosManual").val("");

                return false;

            }

        });

        // La función devuelve el numero redondeado
        function NUM(s, dec) {
            for (var s = s + "", num = "", x = 0; x < s.length; x++) {
                c = s.charAt(x);
                if (".-+/*".indexOf(c) + 1 || c != " " && !isNaN(c)) {
                    num += c;
                }
            }
            if (isNaN(num)) {
                num = eval(num);
            }
            if (num == "") {
                num = 0;
            } else {
                num = parseFloat(num);
            }
            if (dec != undefined) {
                r = .5;
                if (num < 0) r = -r;
                e = Math.pow(10, (dec > 0) ? dec : 0);
                return parseInt(num * e + r) / e;
            } else {
                return num;
            }
        }

        function toFixed(x, n) {

            /*
            if(fixed == "" || fixed == undefined){
                fixed = 2;
            }
            
            if(num == "" || num == undefined){
                num = 0;
            }
            
            console.log(num + ' '+ fixed)
               var re = new RegExp('^-?\\d+(?:\.\\d{0,' + (fixed || -1) + '})?');
               return num.toString().match(re)[0];
               */
            var Truncar = (parseFloat(n) + 1);
            const v = (typeof x === 'string' ? x : x.toString()).split('.');
            if (Truncar <= 0) return v[0];
            let f = v[1] || '';
            if (f.length > Truncar) return NUM(`${v[0]}.${f.substr(0, Truncar)}`, n);
            while (f.length < Truncar) f += '0';
            Numero_Truncado = `${v[0]}.${f}`;

            return NUM(Numero_Truncado, n);
        }

        function exoneraKeyUp(idImpuesto, impuesto, idProducto, value) {
        	var porcentajeExoneracion = $('input[id^="exonera1'+idProducto).attr("data-i");
            var monto = parseFloat($("#exonera2" + idProducto + idImpuesto).val());
            var montoTotal = parseFloat((value / porcentajeExoneracion) * monto);
            $("#exonera4" + idProducto + idImpuesto).val(montoTotal);
            $('.number-format').number(true, [(${ session.SESSION_DECIMALES })], '.', ' ');
        }

        $(document).on("click", ".btn-linea-producto", function () {
            var id = $(this).attr("data-id");
            $("#modalLinea" + id).val($("#precio_" + id).val());
            $("#modalCantidad" + id).val($("#cantidad_" + id).val());
            $("#modalDescuento" + id).val($("#descuento_" + id).val());
            $("#modalUnidadDeMedida" + id).val($("#unidadDeMedida" + id).val());
        });

        function exoneraChange(idImpuesto, impuesto, productoExento, idProducto) {

            var pordentajeExonerado = parseFloat($("#exonera3" + idProducto + idImpuesto).val());

            if (!parseFloat(pordentajeExonerado) > 0) {

                swal("Notificación", "Debe indicar primero el porcentaje y luego marcar la casilla de exonerar ", "warning");

                $("#checkBoxExonera" + idProducto + idImpuesto).prop("checked", false);

                return false;
            }

            var tipoDocumento = $("#tipoDocumento").val();
            if (tipoDocumento === "FEE") {
                swal("", "La Factura Electrónica de Exportación no se puede exonerar.", "warning");
                $("#checkBoxExonera" + idProducto + idImpuesto).prop("checked", false);
                return false;
            }

            var impuestoNeto = 0;
            var impuestoInicial = parseFloat($("#exonera1" + idProducto + idImpuesto).attr("data-i"));
            var pordentajeSinExonerar = parseFloat($("#exonera1" + idProducto + idImpuesto).val());
            var montoSinExonerar = parseFloat($("#exonera2" + idProducto + idImpuesto).val());
            var montoExonerado = parseFloat($("#exonera4" + idProducto + idImpuesto).val());
            var precioProducto = parseFloat($("#precio_" + idProducto).val());
            var cantidadProductos = parseFloat($("#cantidad_" + idProducto).val());
            var descuentoProducto = parseFloat($("#descuento_" + idProducto).val());
            var unidadDeMedida = $("#_unidadDeMedida" + idProducto).val();

            if (parseInt(productoExento) === 1) {
                subtotal = parseFloat($("#subtotal_" + idProducto).val());
            } else {
                subtotal = (toFixed(parseFloat($("#cantidad_" + idProducto).val()), decimales) * toFixed(parseFloat($("#precio_" + idProducto).val()), decimales)) - toFixed(parseFloat($("#monto_descuento_" + idProducto).val()), decimales);
            }

            if ($("#checkBoxExonera" + idProducto + idImpuesto).prop('checked')) {

                var impuestoExonerado = toFixed(parseFloat((pordentajeExonerado / pordentajeExonerado) * impuesto), decimales);

                impuestoNeto = toFixed(parseFloat(montoSinExonerar - montoExonerado), decimales);

                var otrosImps = 0;

                if (parseInt(idImpuesto) != 1) {

                    otrosImps = toFixed(parseFloat((pordentajeExonerado / 13) * impuesto), decimales);

                } else {

                    otrosImps = toFixed(parseFloat((pordentajeExonerado / 13) * impuesto), decimales);

                }

                $("#codigo-" + idProducto).prop("style", "background-color: yellowgreen; color:#FFF !important; font-weight:bold !important");
                $("#impuesto_neto_" + idProducto).val(impuestoNeto);

                this.itemsHelper.calcularImporte(idProducto, precioProducto, parseFloat((impuestoInicial - impuestoExonerado)), productoExento, cantidadProductos, descuentoProducto, unidadDeMedida);

            } else {

                $("#codigo-" + idProducto).prop("style", "background-color: #FFF, color:black !important");
                $("#exonera3" + idProducto + idImpuesto).val(0);
                $("#exonera4" + idProducto + idImpuesto).val(0);
                $("#impuesto_neto_" + idProducto).val(0);

                this.itemsHelper.calcularImporte(idProducto, precioProducto, impuestoInicial, productoExento, cantidadProductos, descuentoProducto, unidadDeMedida);

            }

        }

        var itemsHelper = {
            calcularImporte: function (id, precio, iva, productoExento, cantidad, desc, udm) {

                //Descuento
                var v = $("#descuento_" + id).val();
                var d = $("#descuento_" + id).attr("data-d");

                if (parseFloat(v) > parseFloat(d)) {
                    swal("Notificación", "El monto máximo de descuento que tienes permitido aplicar es: " + d + "%", "warning");
                    $("#descuento_" + id).val(d);
                    desc = d;
                }

                var totalServiciosGravados = 0;
                var totalServiciosExentos = 0;
                var totalServExonerado = 0;

                var totalMercanciasGravadas = 0;
                var totalMercanciasExentas = 0;
                var totalMercExonerada = 0;

                var totalGravados = 0;
                var totalExentos = 0;
                var totalExonerado = 0

                var totalIVADevuelto = 0;
                var totalOtrosCargos = 0;

                var totalVenta = 0;
                var descuento = 0;
                var totalImpuestos = 0;

                var totalLinea = 0;
                var impuestoVenta = 0;

                var montoTotal = 0;
                var subtotal = 0;
                var impuestosMenosIv = 0;

                var totalVentaNeta = 0;
                var totalFactura = 0;

                //Inventario promedio ponderado	        
                //Inventario actual
                var cantidadInventarioActual = $("#inventActual_" + id).val();
                
                var valorInventarioActual = parseFloat(cantidadInventarioActual) * parseFloat($("#precioPromediadoAnterior_" + id).val());

                //Valor de las nuevas existencias
                var valorNuevoInventario = parseFloat(cantidad) * parseFloat(precio);

                //Sumo inventario viejo + el inventario nuevo
                var valorTotalInventario = parseFloat(valorInventarioActual) + parseFloat(valorNuevoInventario);

                //Saco el nuevo valor promediado
                var precioPromediado = parseFloat(valorTotalInventario) / (parseFloat(cantidad) + parseFloat(cantidadInventarioActual));

                //Imprimo el nuevo valor
                $("#precioPromediado_" + + id).val(toFixed(precioPromediado, decimales));

                var impuestoNeto = toFixed(parseFloat($("#impuesto_neto_" + id).val()), decimales);

                if ("[(${V_FACTURADOR})]" === "V1") {
                    //El precio se mantiene		
                } else {
                    if ($("#exonera1" + id + "1").val() === undefined || $("#exonera1" + id + "1").val() == NaN) {
                        precio = precio;
                    } else {
                        var impuesto = parseInt($("#exonera1" + id + "1").val());
                        if (impuesto < 10) {
                            impuesto = "0" + impuesto;
                        }
                        precio = toFixed(parseFloat(precio) / parseFloat(1 + "." + impuesto), decimales);
                    }
                }

                $("#precioUnitario_" + id).val(toFixed(precio, decimales));

                /**
                 *Obtengo los precios 
                 */
                try {

                    if( $("#tipoVenta_" + id).val() == "F" ){
                        var cantidadUnidad = $("#cantidad_" + id).val(); 
                        var precioUnidad   = $("#precio_" + id).val();
                        var montoTotalUnidades = toFixed(parseFloat(cantidadUnidad) * parseFloat(precioUnidad), decimales);
                        var cantidadFraccion = $("#fraccion_" + id).val(); 
                        var precioFraccion   = $("#precioFraccion_" + id).val();
                        var montoTotalFracciones = toFixed(parseFloat(cantidadFraccion) * parseFloat(precioFraccion), decimales);
                        //Productos gravados
                        montoTotal = montoTotalUnidades + montoTotalFracciones;
                    }else{
                        montoTotal = toFixed(parseFloat(precio) * parseFloat(cantidad), decimales);
                    }
                }
                catch(error) {
                    montoTotal = toFixed(parseFloat(precio) * parseFloat(cantidad), decimales);
                }
 
                $("#montoTotal_" + id).val(montoTotal);

                //Descuentos
                if (desc > 0) {
                    descuento = toFixed(parseFloat((montoTotal / 100) * desc), decimales);
                } else {
                    descuento = 0;
                }

                // 1 = Gravado
                var totalSerMerExonerados = 0;

                var porcentajeExoneradoIva = 0;
                if (parseInt(productoExento) === 1) {

                    totalGravados = montoTotal;

                    if (ArrayUnidadesMedida.includes(udm.trim())) {
                        totalServiciosGravados = montoTotal;
                        $('input[id^="exonera3' + id + '"]').each(function () {
                            //Solo el IVA se envia a Total serv exonerado
                            if (parseInt($(this).attr("data-iva-id")) === 1) {
                                porcentajeExoneradoIva = $('input[id^="exonera1'+id).attr("data-i");   
    
                                if(porcentajeExoneradoIva > 0){
                                	totalServExonerado += toFixed( (parseFloat($(this).val() * totalServiciosGravados) / porcentajeExoneradoIva), decimales );
                                }else{
                                	totalServExonerado += toFixed(parseFloat($(this).val() * totalServiciosGravados), decimales);
                                }               
                                
                                $('#totalServExonerado_' + id).val( totalServExonerado );
                            }
                        });
                    } else {
                        totalMercanciasGravadas = montoTotal;
                        $('input[id^="exonera3' + id + '"]').each(function () {
                            //Solo el IVA se envia a Total merc exonerada
                            if (parseInt($(this).attr("data-iva-id")) === 1) {
                            	porcentajeExoneradoIva = $('input[id^="exonera1'+id).attr("data-i");   
                            	
                            	if(porcentajeExoneradoIva > 0){
                            		totalMercExonerada += toFixed((parseFloat($(this).val() * totalMercanciasGravadas) / porcentajeExoneradoIva), decimales);
                            	}else{
                            		totalMercExonerada += toFixed(parseFloat($(this).val() * totalMercanciasGravadas), decimales);
                            	}                                
                            	
                                $('#totalMercExonerada_' + id).val( totalMercExonerada );
                            }
                        });
                    }
                    totalExonerado = parseFloat(totalMercExonerada + totalServExonerado);

                    //Obtengo el valor de los impuestos
                    var z = 0;
                    var impuestoTable = "";

                    //1 = IVA
                    $('#exonera2' + id + '1').each(function () {

                        z++;
                        $(this).val(((toFixed(parseFloat(precio), decimales) * toFixed(parseFloat(cantidad), decimales) - toFixed(parseFloat(descuento), decimales)) / 100) * $(this).attr("data-tarifa"));

                        //z=1 esto indica que 1 es IVA
                        if (z == 1) {
                            iv = $(this).attr("data-tarifa");

                            //Asigno el valor del IVA en la linea correspondiente
                            $('#impuesto_' + id).val($(this).attr("data-tarifa"));

                            //Obtengo el selector para actualizar el impuesto
                            impuestoTable = 'exonera2' + id + z;

                            //Obtengo el impuesto de venta
                            impuestoVenta = impuestoVenta += ((toFixed(parseFloat(precio), decimales) * toFixed(parseFloat(cantidad), decimales) - toFixed(parseFloat(descuento), decimales)) / 100) * $(this).attr("data-tarifa");

                        } else {
                            impuestosMenosIv = impuestosMenosIv + ((toFixed(parseFloat(precio), decimales) * toFixed(parseFloat(cantidad), decimales) - toFixed(parseFloat(descuento), decimales)) / 100) * $(this).attr("data-tarifa");
                            // console.log("impuestosMenosIv " + impuestosMenosIv);
                        }

                        //Impuesto de venta por linea //         ( ( montoTotal / 100 ) - descuento ) + impuestosMenosIv
                        impuestoVenta = toFixed(parseFloat((((montoTotal + impuestosMenosIv) - descuento) / 100) * iv), decimales);

                        //Impuesto total por linea
                        $("#impuesto_total_" + id).val(toFixed(parseFloat(impuestoVenta), decimales));

                        //Actualizo el impuesto de venta de la tabla de impuestos        					
                        $('#' + impuestoTable).val(toFixed(parseFloat(impuestoVenta), decimales));

                    });
 

                } else {
                    totalExentos = montoTotal;

                    if (ArrayUnidadesMedida.includes(udm.trim())) {
                        totalServiciosExentos = parseFloat(montoTotal);
                    } else {
                        totalMercanciasExentas = parseFloat(montoTotal);
                    }
                    impuestosMenosIv = 0;
                    impuestoVenta = 0;
                }

                //Sub total por linea
                subtotal = toFixed(parseFloat(montoTotal) - parseFloat(descuento), decimales);

                impuestoNeto = $("#impuesto_neto_" + id).val();

                var totalImpuestoExonerado = 0;
                $('input[id^="exonera4' + id + '"]').each(function () {
                    totalImpuestoExonerado += parseFloat($(this).val());
                });

                //Total de la linea
                totalLinea = (parseFloat(toFixed(subtotal, decimales)) + parseFloat(toFixed(impuestoVenta, decimales)) + parseFloat(toFixed(impuestosMenosIv, decimales))) - parseFloat(toFixed(totalImpuestoExonerado, decimales));

                //Subtotal por linea
                $("#subtotal_" + id).val(subtotal);

                //Monto total de descuento por linea 
                $("#monto_descuento_" + id).val(descuento);

                //Monto total por linea 
                $("#total_importe_" + id).val(totalLinea);

                //Resumen Factura
                //Total Servicios Gravados .toFixed(decimales)
                var _totalServiciosGravados = parseFloat(totalServiciosGravados - totalServExonerado);
                $("#totalServiciosGravados_" + id).val(toFixed(_totalServiciosGravados, decimales));

                //Total Gravado
                totalGravados = parseFloat((totalServiciosGravados + totalMercanciasGravadas) - totalExonerado);
                $("#totalGravados_" + id).val(toFixed(totalGravados, decimales));

                //Total mercancias Gravadas .toFixed(decimales)
                var _totalMercanciaGravadas = parseFloat(totalMercanciasGravadas - totalMercExonerada);
                $("#totalMercanciaGravadas_" + id).val(toFixed(_totalMercanciaGravadas, decimales));

                //Total Exento
                totalExentos = parseFloat(totalServiciosExentos + totalMercanciasExentas);
                $("#totalExentos_" + id).val(toFixed(totalExentos, decimales));

                //Total servicios exentos
                $("#totalServiciosExentos_" + id).val(toFixed(totalServiciosExentos, decimales));

                //Total mercancias Exentas
                $("#totalMercanciasExentas_" + id).val(toFixed(totalMercanciasExentas, decimales));


                $("#totalExonerado_" + id).val(toFixed(totalExonerado, decimales));

                //Monto total descuento
                $("#monto_descuento_" + id).val(toFixed(descuento, decimales));

                //Total de la Venta
                totalVenta = parseFloat(totalGravados + totalExentos + totalExonerado);
                $("#totalVenta_" + id).val(toFixed(totalVenta, decimales));

                //Si impuesto neto es mayor a 0 es exonerado en algún porcentaje
                if (impuestoNeto > 0) {
                    totalFactura = parseFloat(totalVentaNeta) + parseFloat(impuestoNeto) + impuestosMenosIv;
                }

                var _totalFactura = parseFloat(totalFactura + impuestosMenosIv);
                $("#totalFactura_" + id).val(toFixed(_totalFactura, decimales));

                this.totalServiciosGravados();
                this.totalServiciosExentos();
                this.totalServiciosExonerados();
                this.totalMercanciaGravadas();
                this.totalMercanciasExentas();
                this.totalMercanciasExoneradas();                
                this.totalGravados();
                this.totalExentos();
                this.totalExonerado();
                this.totalVenta();
                this.descuentos();
                this.totalVentaNeta();
                this.totalImpuestos();
                this.totalIvaDevuelto();
                this.totalOtrosCargos();
                this.totalFactura();

                contarLineasFactura();

                $('.dd-mm-yyyy').datepicker({
                    autoclose: true,
                    format: 'dd/mm/yyyy',
                    todayHighlight: true
                });

                $('.number-format').number(true, [(${ session.SESSION_DECIMALES })], '.', ' ');

                $('._select2_').select2({
                    placeholder: 'Seleccione un elemento'
                });

            },
            hasProducto: function (id) {
                var resultado = false;
                $('input[name="item_id[]"]').each(function () {
                    if (parseInt(id) == parseInt($(this).val())) {
                        resultado = true;
                    }
                });
                return resultado;
            },
            incrementaCantidad: function (id, precio, iva, productoExento, cantidad, desc, udm) {
                var cantidad = $("#cantidad_" + id).val() ? $("#cantidad_" + id).val() : 0;
                $("#cantidad_" + id).val(++cantidad);
                this.calcularImporte(id, precio, iva, productoExento, cantidad, desc, udm);
            },
            eliminarLineaFactura: function (id) {
                $("#row_" + id).remove();
                this.totalFactura();
                this.calcularImporte(id, 0.00, 0.00, '', 0.00, 0.00, '');
            },
            totalServiciosGravados: function () {
                var total = 0;
                $('input[id^="totalServiciosGravados_"]').each(function () {
                    total += parseFloat($(this).val());
                });
                $('#totalServiciosGravados').val(total);
            },
            totalServiciosExentos: function () {
                var total = 0;
                $('input[id^="totalServiciosExentos_"]').each(function () {
                    total += parseFloat($(this).val());
                });
                $('#totalServiciosExentos').val(total);
            },
            totalServiciosExonerados: function () {
                var total = 0;
                $('input[id^="totalServExonerado_"]').each(function () {
                    total += parseFloat($(this).val());
                });
                $('#totalServiciosExonerado').val(total);
            },

            totalMercanciaGravadas: function () {
                var total = 0;
                $('input[id^="totalMercanciaGravadas_"]').each(function () {
                    total += parseFloat($(this).val());
                });
                $('#totalMercanciaGravadas').val(total);
            },
            totalMercanciasExentas: function () {
                var total = 0;
                $('input[id^="totalMercanciasExentas_"]').each(function () {
                    total += parseFloat($(this).val());
                });
                $('#totalMercanciasExentas').val(total);
            },
            totalMercanciasExoneradas: function () {
                var total = 0;
                $('input[id^="totalMercExonerada_"]').each(function () {
                    total += parseFloat($(this).val());
                });
                $('#totalMercanciasExonerada').val(total);
            },            
            totalGravados: function () {
                var totalGravados = parseFloat($("#totalServiciosGravados").val()) + parseFloat($("#totalMercanciaGravadas").val());
                $('#totalGravados').val(totalGravados);
            },
            totalExentos: function () {
                var totalExentos = parseFloat($("#totalServiciosExentos").val()) + parseFloat($("#totalMercanciasExentas").val());
                $('#totalExentos').val(totalExentos);
            },
            totalExonerado: function () {
                var totalExonerado = parseFloat($("#totalServiciosExonerado").val()) + parseFloat($("#totalMercanciasExonerada").val())
                $('#totalExonerado').val(totalExonerado);
            },
            totalVenta: function () {
            	var total = 0;
                var tg  = parseFloat($("#totalGravados").val());
                var te  = parseFloat($("#totalExentos").val());
                var tex = parseFloat($("#totalExonerado").val());
                
                total = tg + te + tex;

                $('#totalVenta').val(total);
                $('#totalVentaSumary').val(total);
            },
            descuentos: function () {
                var total = 0;
                $('input[id^="monto_descuento_"]').each(function () {
                    total += parseFloat($(this).val());
                });
                $('#descuentos').val(total);
            },
            totalImpuestos: function () {
                var total = 0;
                var impNeto = 0;
                var impuestos = 0;

                $('input[id^="exonera2"]').each(function () {
                    total += parseFloat($(this).val());
                });
                $('input[id^="exonera4"]').each(function () {
                    impNeto += parseFloat($(this).val());
                });

                impuestos = total - impNeto;

                if (impuestos <= 0) {
                    impuestos = 0;
                }

                $('#totalImpuestos').val(impuestos);
                $('#totalImpuestosSumary').val(impuestos);
            },
            totalIvaDevuelto: function () {
                
            },            
            totalVentaNeta: function () {
                var totalVenta = parseFloat($("#totalVenta").val()) - parseFloat($("#descuentos").val());
                $('#totalVentaNeta').val(totalVenta);
            },
            totalOtrosCargos: function () {
                var total = 0;
                $('input[id^="otrosCargosMontoCargo"]').each(function () {
                    if ($.isNumeric($(this).val())) {
                        total += parseFloat($(this).val());
                    }
                });

                $('#totalOtrosCargos').val(total);
            },
            totalFactura: function () {

                var totalComprobante = 0;
                var totalImpuestos = $("#totalImpuestos").val();
                var totalOtrosCargos = $("#totalOtrosCargos").val();
                var totalVentaNeta = $("#totalVentaNeta").val();
                var totalIVADevuelto = $("#totalIVADevuelto").val() != "" ? $("#totalIVADevuelto").val() : 0;

                totalComprobante = (parseFloat(totalImpuestos) + parseFloat(totalOtrosCargos) + parseFloat(totalVentaNeta)) - parseFloat(totalIVADevuelto);

                $('#totalFactura, #totalAPagar, .totalAPagarNc').val(totalComprobante);

                $('#totalFacturaSumary').val(totalComprobante);
            },

        }
        
        function devolucionIva(){
        	var diva  = 0;        	
        	if ($("#aplicarDevolucionIva").prop('checked')) {
        		$('input[id^="impuesto_total_"]').each(function () {      
                	var vdiva = $(this).attr("data-diva");
                	if(vdiva == "S"){
                		diva += parseFloat($(this).val());
                	}                    
                });
        	}        	
        	$("#ivaDevuelto").val(diva);        	
        	$('#totalIVADevuelto').val(diva);            
            CalcularTotalComprobante();
        	
        	if(diva > 0){
        		$(".ivaDevuelto").show();
        		$("#medioPago2").val( $("#totalAPagar").val() ); 
        		$(".medio-pago-tarjeta").show();
        		$(".input-medio-pago-tarjeta").prop("required", true);
        		$(".input-medio-pago-tarjeta:first").focus();
        	}else{
        		$(".ivaDevuelto").hide();
        		$("#medioPago2").val( 0 );     
        		$(".medio-pago-tarjeta").hide();
        		$(".input-medio-pago-tarjeta").prop("required", false);
        	}

        }

        function CalcularTotalComprobante() {

            //Primero refresco los otros cargos
            var total = 0;
            $('input[id^="otrosCargosMontoCargo"]').each(function () {
                if ($.isNumeric($(this).val())) {
                    total += parseFloat($(this).val());
                }
            });

            $('#totalOtrosCargos').val(total);

            //Luego calculo el total del documento
            var totalComprobante = 0;
            var totalImpuestos = $("#totalImpuestos").val();
            var totalOtrosCargos = $("#totalOtrosCargos").val();
            var totalVentaNeta = $("#totalVentaNeta").val();
            var totalIVADevuelto = $("#totalIVADevuelto").val();

            totalComprobante = (parseFloat(totalImpuestos) + parseFloat(totalOtrosCargos) + parseFloat(totalVentaNeta)) - parseFloat(totalIVADevuelto);

            $('#totalFactura, #totalAPagar').val(totalComprobante);
            
            $('#totalFacturaSumary').val(totalComprobante);
        }

        $(document).on("keyup", ".inputOtrosCargos", function () {
            CalcularTotalComprobante();
        });

        $(document).on("click", ".deleteOtrosCargos", function () {
            CalcularTotalComprobante();
        });

        /* window.onbeforeunload = function(e) {
          return 'Si refresca se borraran todos los datos de la factura.';
        }; */

        $(".select-all").on("click", function () {
            $(this).select();
        });

        $(document).on("change", "#codMoneda", function (e) {
            e.preventDefault();

            $("#tipoCambio").val(parseFloat($("#moneda" + $(this).val()).val()).toFixed(2));

            if (parseInt($(this).val()) === 1) {
                $(".simbolo-moneda").text("¢");
            } else if (parseInt($(this).val()) === 2) {
                $(".simbolo-moneda").text("$");
            } else if (parseInt($(this).val()) === 3) {
                $(".simbolo-moneda").text("€");
            }

            /*
            itemsHelper.totalFactura();
            itemsHelper.calcularImporte(0, 0.00, 0.00, '', 0.00, 0.00, '');
        
            if ($("#cargarItemProductos tbody tr").length > 0) {
                swal("Notificación", "Al cambiar de moneda debe completar nuevamente las líneas de la factura.", "warning");
            }
        
            $("#loadLineasFactura").html("");
            */

            cambiarPrecios();

            //Asigno el nuevo tipo de pago
            asignaTipoPago();

        });

        $(document).on('change', '#tipoDeIdentificacion', function () {

            var v = $(this).val();

            $("#identificacion").val("");

            if (v != "") {
                $("#identificacion").removeAttr("disabled");
            } else {
                $("#identificacion").attr("disabled", true);
            }

            if (v == "1") {
                //fisico
                $("#identificacion").attr('maxlength', '9');
                $("#telefono1").attr('maxlength', '8');
                $("#telefono2").attr('maxlength', '8');
                $("#fax").attr('maxlength', '8');
            } else if (v == "2") {
                //juricio
                $("#identificacion").attr('maxlength', '10');
                $("#telefono1").attr('maxlength', '8');
                $("#telefono2").attr('maxlength', '8');
                $("#fax").attr('maxlength', '8');
            } else if (v == "4") {
                //Nite
                $("#identificacion").attr('maxlength', '10');
                $("#telefono1").attr('maxlength', '20');
                $("#telefono2").attr('maxlength', '20');
                $("#fax").attr('maxlength', '20');
            } else if (v == "5") {
                //Extrangero
                $("#identificacion").attr('maxlength', '20');
                $("#telefono1").attr('maxlength', '20');
                $("#telefono2").attr('maxlength', '20');
                $("#fax").attr('maxlength', '20');
            } else {
                //Dimex máximo 12
                $("#identificacion").attr('maxlength', '12');
                $("#identificacion").removeClass("iden_fisica");
                $("#identificacion").removeClass("iden_juridica");
                $("#telefono1").attr('maxlength', '20');
                $("#telefono2").attr('maxlength', '20');
                $("#fax").attr('maxlength', '20');
            }

            if ($(this).val() != "") {
                $(".error").fadeOut();
                return false;
            }

        });

        $("#formAddCliente").submit(function (event) {

            //Valido las cédulas
            var v = parseInt($("#tipoDeIdentificacion").val());
            var i = $("#identificacion").val();

            if (v === 1) {

                //fisico
                if (i.length != 9) {

                    swal({
                        text: "¡La “Cédula física” debe de contener 9 dígitos, sin cero al inicio y sin guiones!",
                        button: {
                            text: "Aceptar",
                        },
                        icon: "warning",
                        closeModal: false
                    }).then(function () {
                        swal.close();
                        $("#identificacion").focus();
                    });

                    return false;
                }

            } else if (v === 2) {
                //juricio
                if (i.length != 10) {

                    swal({
                        text: "¡La “cédula de personas Jurídicas” debe contener 10 dígitos y sin guiones!",
                        button: {
                            text: "Aceptar",
                        },
                        icon: "warning",
                        closeModal: false
                    }).then(function () {
                        swal.close();
                        $("#identificacion").focus();
                    });

                    return false;
                }
            } else if (v === 4) {
                //juricio
                if (i.length != 10) {

                    swal({
                        text: "¡El “Documento de Identificación de la DGT (NITE)” debe contener 10 dígitos y sin guiones!",
                        button: {
                            text: "Aceptar",
                        },
                        icon: "warning",
                        closeModal: false
                    }).then(function () {
                        swal.close();
                        $("#identificacion").focus();
                    });

                    return false;
                }
            }

            var tel1 = $("#telefono1").val();
            var tel2 = $("#telefono2").val();
            var fax = $("#fax").val();
            var cp = $("#codigoPais").val();

            if (v > 2) {
                //Si el tipo de identificación es mayor a 2 no la valido.
            } else {
                //Valido los teléfonos
            }

            if (tel1.length > 0 || tel2.length > 0 || fax.length > 0) {

                if (cp.length > 0) {
                    //Puede continuar
                    if (tel1.length != 8) {

                        if (v === 1 || v === 2) {
                            swal({
                                text: "¡El número de teléfono debe contener 8 dígitos, sin espacios y sin guiones!",
                                button: {
                                    text: "Aceptar",
                                },
                                icon: "warning",
                                closeModal: false
                            }).then(function () {
                                swal.close();
                                $("#telefono1").focus();
                            });
                            return false;
                        }

                    }

                    if (tel2 != "") {
                        if (tel2.length != 8) {

                            if (v === 1 || v === 2) {
                                swal({
                                    text: "¡El número de teléfono debe contener 8 dígitos, sin espacios y sin guiones!",
                                    button: {
                                        text: "Aceptar",
                                    },
                                    icon: "warning",
                                    closeModal: false
                                }).then(function () {
                                    swal.close();
                                    $("#telefono2").focus();
                                });

                                return false;
                            }
                        }
                    }
                } else {

                    swal({
                        text: "¡Al incluir un número telefónico, el código de país será requerido, debe completarlo.!",
                        button: {
                            text: "Aceptar",
                        },
                        icon: "warning",
                        closeModal: false
                    }).then(function () {
                        swal.close();
                        $("#codigoPais").focus();
                    });

                    return false;

                }

            }

            $.ajax({
                type: "POST",
                cache: false,
                beforeSend: function () {
                    loadingShow();
                },
                url: "[(@{/clientes/form/save})]",
                data: $(this).serialize(),
                success: function (data) {

                    if (parseInt(data.response) === 1) {

                        swal({
                            text: "El cliente se ingreso con éxito.",
                            button: {
                                text: "Aceptar",
                            },
                            icon: "success",
                            closeModal: false
                        }).then(function () {
                            swal.close();
                            $("#formAddCliente").trigger("reset");
                            $('#ModalNuevoCliente').modal('toggle');
                            $("#inputBuscarClientes").focus();
                        });

                    } else if (parseInt(data.response) === 0) {
                        location.href = "[(@{/})]"
                    } else {
                        swal("", "La identificación del cliente o el correo 1 ya existen, debe cambiarlo", "warning");
                    }


                },
                complete: function () {
                    loadingHide();
                },
                error: function (x, t, m) {
                    if (t === "timeout") {

                    } else {

                    }
                }
            });

            return false;
        });

        $(document).on("change", "#provincia", function (e) {

            e.preventDefault();

            $.ajax({
                type: "POST",
                cache: false,
                beforeSend: function () { },
                url: "[(@{/ubicacion/cantones})]",
                data: {
                    id: $(this).val(),
                    _csrf: token
                },
                success: function (data) {
                    $("#canton").html(data);
                    $('#canton').select2('open');
                },
                complete: function () {
                    //loading_hide();
                },
                error: function (x, t, m) {
                    if (t === "timeout") {

                    } else {

                    }
                }
            });

        });

        $(document).on("change", "#canton", function (e) {

            e.preventDefault();

            $.ajax({
                type: "POST",
                cache: false,
                beforeSend: function () { },
                url: "[(@{/ubicacion/distritos})]",
                data: {
                    id: $(this).val(),
                    _csrf: token
                },
                success: function (data) {
                    $("#distrito").html(data);
                    $('#distrito').select2('open');
                },
                complete: function () {
                    //loading_hide();
                },
                error: function (x, t, m) {
                    if (t === "timeout") {

                    } else {

                    }
                }
            });

        });

        $(document).on("change", "#distrito", function (e) {

            e.preventDefault();

            $.ajax({
                type: "POST",
                cache: false,
                beforeSend: function () { },
                url: "[(@{/ubicacion/barrios})]",
                data: {
                    id: $(this).val(),
                    _csrf: token
                },
                success: function (data) {
                    $("#barrio").html(data);
                    $('#barrio').select2('open');
                },
                complete: function () {
                    //loading_hide();
                },
                error: function (x, t, m) {
                    if (t === "timeout") {

                    } else {

                    }
                }
            });

        });

        $(document).on("click", ".reload-page", function () {
            location.reload();
        });

        document.addEventListener('keydown', function (event) {
            if (event.ctrlKey) {
                if (event.keyCode == 13 || event.keyCode == 17 || event.keyCode == 74)
                    event.preventDefault();
            }
        });

        $(document).on("click", "._tipoBusquedaProductos", function (e) {

            if ($(this).val() == "S") {
                $("#inputBuscarProductosManual").hide();
                $("#inputBuscarProductos").show();
                $("#inputBuscarProductos").focus();
            } else {
                $("#inputBuscarProductosManual").show();
                $("#inputBuscarProductosManual").focus();
                $("#inputBuscarProductos").hide();
            }

        });

        function validarCobroVenta() {

            var ti = $("#inputClientesTipoIdentificacionHidden").val();
            var td = $("#tipoDocumento").val();
            var tc = $("#tipoCambio").val();
            var or = $("#omitirReceptor").val();
            var cm = $("#codMoneda").val();

            if (td === "PR") {
                swal("Notificación", "Cambie el tipo de documento para poder emitir la factura", "warning");
            } else {

                if (td === "FEE") {
                    var c = 0;
                    $('input[id^="_partidaArancelaria"]').each(function () {
                        u = $(this).attr("data-um");
                        if (ArrayUnidadesMedida.includes(u.trim())) {
                            $(this).prop("required", false);
                        } else {

                            if ($(this).val() == "") {
                                c++;
                                $(this).prop("required", true);
                            }

                        }
                    });
                    //console.log("valor de c:" + c);
                    if ((c - 1) > 0) {
                        swal("", "Es requerido completar la partida arancelaria para las mercancias.", "warning");
                        return false;
                    }
                } else {
                    $('input[id^="_partidaArancelaria"]').each(function () {
                        $(this).prop("required", false);
                    });
                }

                if (or === "false") {

                    if (ti != "") {
                        //No pasada nada
                    } else {
                        swal("", "Incluir receptor esta activo, debe desactivarlo o bien seleccionar un cliente.", "warning");
                        $('#omitirReceptor').select2('open');
                        return false;
                    }
                } else {
                    if (td == "FE" || td == "FEC") {
                        swal("", "Para emitir una Factura Electrónica o una Factura Electrónica de Compra, debe incluir los datos del cliente, o bien cambiar de tipo de documento", "warning");
                        return false;
                    }
                }

                if (tc == "") {
                    swal("", "Debe asignar el tipo de cambio de la moneda para continuar", "warning");
                    return false;
                }

                if (td == "FE" || td == "FEC") {

                    if ($("#inputClientesHidden").val() != "") {
                        //Continue
                    } else {
                        swal("", "Para emitir una Factura Electrónica o una Factura Electrónica de Compra, debe seleccionar un cliente, o bien cambiar de tipo de documento", "warning");
                        return false;
                    }

                } else {
                    $("#inputBuscarClientes").prop("required", false);
                }

                if ($("#cargarItemProductos tbody tr").length === 0) {
                    swal("", "Debe facturar almenos un producto.", "warning");
                    $("#inputBuscarProductos").focus();
                    return false;
                }

                if (parseFloat($('#totalExonerado').val()) > 0) {

                    $("#exoneraTipoDocumentoExonera").prop("required", true);
                    $("#exoneraNumero").prop("required", true);
                    $("#exoneraInstitucion").prop("required", true);
                    $("#exoneraFechaEmision").prop("required", true);

                    if ($("#exoneraTipoDocumentoExonera").val() == "") {
                        swal("", "¡Tipo de documento de exoneración es requerido!", "warning");
                        return false;
                    }

                    if ($("#exoneraNumero").val() == "") {
                        swal("", "¡Número de documento de exoneración es requerido!", "warning");
                        return false;
                    }

                    if ($("#exoneraInstitucion").val() == "") {
                        swal("", "¡Nombre de la Institución que exonera es requerido!", "warning");
                        return false;
                    }

                    if ($("#exoneraFechaEmision").val() == "") {
                        swal("", "¡Fecha de la emisión de la exoneración es requerido!", "warning");
                        return false;
                    }

                } else {
                    $("#exoneraTipoDocumentoExonera").prop("required", false);
                    $("#exoneraNumero").prop("required", false);
                    $("#exoneraInstitucion").prop("required", false);
                    $("#exoneraFechaEmision").prop("required", false);
                }

                if (parseInt(ti) === 5 && (td == "FE" || td == "FEC")) {
                    $('#modalPagar').modal('hide');
                    swal("", "A un cliente extrangero NO se le puede emitir Factura Electrónica ni Factura Electrónica de Compra, debe cambiar el tipo de documento, por ejemplo: Tiquete Electrónico.", "warning");
                } else {
                    documentoAGenerar(); //Muestra el tipo de documento que se va a generar antes de pagar
                    $('#modalPagar').modal('show');
                    setTimeout(function () {

                        switch (parseInt(cm)) {
                            case 1:
                                $('#medioPago1').focus();
                                $('#medioPago1').select();
                                break;
                            case 2:
                                $('#medioPagoDolar1').focus();
                                $('#medioPagoDolar1').select();
                                break;
                            case 3:
                                $('#medioPagoEuro1').focus();
                                $('#medioPagoEuro1').select();
                                break;
                            default:
                                break;
                        }

                    }, 500);

                }

            }

        }

        $("#formEmitirFactura").submit(function (event) {

            var td = $("#tipoDocumento").val();
            var or = $("#omitirReceptor").val();
            var cv = $("#condVenta").val();
            
            var totalPagos = 0;
            $('input[id^="medioPago"]').each(function () {
                totalPagos += parseFloat($(this).val());
            });

            var tp = parseFloat($("#totalAPagar").val());
            if (totalPagos == "" || totalPagos == 0) {
            	
            	swal({
            	      title: "Notificación",
            	      text: "Debe digitar el dinero que va a recibir para indicar el vuelto y aplicar el medio de pago.",
            	      icon: "warning",
            	      button: "Corregir"
            	    }).then(result => {
            	          $("#medioPago1").focus();
            	        }
            	    );
            	
                return false;
            }

            if (td != "PR") {
                if (parseInt($("#condVenta").val()) === 2) {
                    if (td === "TE" && or === "true") {
                        swal("Notificación", "Debe incluir un cliente para facturar a crédito.", "warning")
                        return false;
                    }

                    if (parseInt($("#plazoCredito").val()) >= 1) {

                    } else {
                        swal("Notificación", "El plazo de crédito debe ser como mínimo 1 día", "warning");
                        return false;
                    }
                }

                if ($("#cargarItemProductos tbody tr").length === 0) {
                    swal("", "Debe facturar almenos un producto.", "warning");
                    $("#inputBuscarProductos").focus();
                    return false;
                }

                if ($("#omitirReceptor").val() === "false") {
                    $('#inputBuscarClientes').prop('required', true);
                } else {
                    $('#inputBuscarClientes').prop('required', false);
                }

                var suVuelto = parseFloat($(".suVuelto").val());
                if(parseInt(cv) === 2){

                    //Si la venta es a crédito omito los medios de pago

                }else{
                    if ( suVuelto < 0) {

	                    swal({
						  title: "Notificación",
						  text: "El total a pagar no puede ser mayor al dinero recibido.",
						  icon: "warning",
						  button: "Corregir",
						});
							                    
	                    return false;
                    }
                }
                

            } else {

                if ($("#cargarItemProductos tbody tr").length === 0) {
                    swal("", "Debe facturar almenos un producto.", "warning");
                    $("#inputBuscarProductos").focus();
                    return false;
                }

                if ($("#omitirReceptor").val() === "false") {
                    $('#inputBuscarClientes').prop('required', true);
                } else {
                    $('#inputBuscarClientes').prop('required', false);
                }
            }

            validarCobroVenta();

            var urlPath = "[(@{/imprimir-factura/})]";

            $.ajax({
                type: "POST",
                cache: false,
                beforeSend: function () {
                    loadingShow();
                    $("#btnEmitirFactura").prop("disabled", true);
                },
                url: "[(@{/proformas/emitir-factura})]",
                data: $(this).serialize(),
                success: function (data) {

                    if (parseInt(data.response) === 200) {

                        if (td != "PR") {

                            $("#responseClave").val(data.clave);
                            $("#responseConsecutivo").val(data.consecutivo);
                            $('#modalFinVenta').modal('show');

                            $("#inputImprimirFactura").val(urlPath + data.clave);
                            $("#inputImprimirFacturaPdf").val("[(@{/imprimir-factura/})]" + data.clave);

                            var t = '[(${SESSION_CONTROL_IMPRESION})]';
                            var urlPrint = urlPath + data.clave + "/?print=" + t;

                            if (!isMobile.any()) {

                                setTimeout(function () {

                                    printJS(urlPrint);

                                }, 100);

                            } else {
                                openInNewTab(urlPrint);
                            }

                        } else {
                            swal("Notificación", "¡Proforma guardada con éxito!", "success");
                        }

                    } else if (parseInt(data.response) === 201) {
                        $("#responseClave").val(data.clave);
                        $("#responseConsecutivo").val(data.consecutivo);
                        swal("Notificación", "" + data.msj + "", "warning");
                        //$('#modalFinVenta').modal('show');
                    } else {
                        swal("Notificación", "¡Ocurrió un error, la venta no se aplico contacte al desarrollador!", "warning");
                    }

                }, complete: function () {
                    loadingHide();
                }, error: function (x, t, m) {
                    if (t === "timeout") {

                    } else {

                    }
                }
            });
            return false;
        });

        function guardarProforma() {
            var td = $("#tipoDocumento").val();
            var or = $("#omitirReceptor").val();

            if (td != "PR") {

                swal("Notificación", "[(${MENSAJE_FORM3})]", "warning");
                return false;

            } else {

                if ($("#cargarItemProductos tbody tr").length === 0) {
                    swal("", "Debe facturar almenos un producto.", "warning");
                    $("#inputBuscarProductos").focus();
                    return false;
                }

                if ($("#omitirReceptor").val() === "false") {
                    $('#inputBuscarClientes').prop('required', true);
                } else {
                    $('#inputBuscarClientes').prop('required', false);
                }
            }

            $.ajax({
                type: "POST",
                cache: false,
                beforeSend: function () {
                    loadingShow();
                },
                url: "[(@{/proformas/emitir-factura})]",
                data: $("#formEmitirFactura").serialize(),
                success: function (data) {

                    if (parseInt(data.response) === 200) {

                        if (td != "PR") {
                            $("#responseClave").val(data.clave);
                            $("#responseConsecutivo").val(data.consecutivo);
                            $('#modalFinVenta').modal('show');
                        } else {

                            if ($("#_idf").val() != "") {

                                //swal("Notificación", "Proforma guardada con éxito, refrescando formulario.", "success");
                                /*
                                swal({   
                                    icon: "success",
                                    title: "Notificación",   
                                    text: "Proforma guardada con éxito, refrescando formulario.",   
                                    timer: 2000,   
                                    showConfirmButton: false 
                                });
                                */

                                notificacion('[(${MENSAJE_FORM1})]');

                                /*
                                setTimeout(function(){
                                    //location.reload();
                                    }, 1300);
                                */

                            } else {
                                swal("Notificación", "[(${MENSAJE_FORM1})]", "success");

                                setTimeout(function () {
                                    location.href = "[(@{${ACTION_FORM}})]" + data.factura_id;
                                }, 1300);
                            }
                        }

                    } else if (parseInt(data.response) === 201) {
                        $("#responseClave").val(data.clave);
                        $("#responseConsecutivo").val(data.consecutivo);
                        swal("Notificación", "" + data.msj + "", "warning");
                        //$('#modalFinVenta').modal('show');
                    } else {
                        swal("Notificación", "¡Ocurrió un error, la proforma no se aplico contacte al desarrollador!", "warning");
                    }

                }, complete: function () {
                    loadingHide();
                }, error: function (x, t, m) {
                    if (t === "timeout") {

                    } else {

                    }
                }
            });
            return false;
        }

        $(document).on("click", "#btnGuardarProforma", function () {
            guardarProforma();
        });

        function contarLineasFactura() {
            var count = -1;
            var productos = -1;

            $('tr[id^="row_"]').each(function () {
                count = parseInt(count) + 1;
            });

            $('input[id^="cantidad_"]').each(function () {
                productos = parseFloat(productos) + parseFloat($(this).val());
            });

            $("#totalLineasFactura").text(count);
            $("#totalProductos").text(productos);
        }

        contarLineasFactura();

        function cambiarPrecios() {

            $('tr[id^="row_"]').each(function () {

                var id = $(this).attr("data-id");

                if (id == "{ID}" || id == "undefined") {

                } else {

                    console.log("IMPRIMIRENDO " + id);

                    var cantidad = $("#cantidad_" + id).val();
                    var precio = $("#precio_" + id).val();
                    var subTotal = $("#subtotal_" + id).val();
                    var impuesto = $("#impuesto_" + id).val();
                    var impuestoTotal = $("#impuesto_total_" + id).val();
                    var iva = $("#exonera2" + id + "1").val();
                    var montoExonerado = $("#exonera4" + id + "1").val();
                    var totalLinea = $("#total_importe_" + id).val();
                    var condProducto = $("#_condicionProducto" + id).val();
                    var descuento = $("#descuento_" + id).val();
                    var unidadDeMedida = $("#_unidadDeMedida" + id).val();
                    var monedaActual = $("#moneda_" + id).val();
                    var precioFraccion = $("#precioFraccion_" + id).val();

                    //Totales
                    var totalServiciosGravados = $("#totalServiciosGravados_" + id).val();
                    var totalServiciosExentos = $("#totalServiciosExentos_" + id).val();
                    var totalServExonerado = $("#totalServExonerado_" + id).val();
                    var totalMercanciaGravadas = $("#totalMercanciaGravadas_" + id).val();
                    var totalMercanciasExentas = $("#totalMercanciasExentas_" + id).val();
                    var totalMercExonerada = $("#totalMercExonerada_" + id).val();
                    var totalGravados = $("#totalGravados_" + id).val();
                    var totalExentos = $("#totalExentos_" + id).val();
                    var totalExonerado = $("#totalExonerado_" + id).val();
                    var totalVenta = $("#totalVenta_" + id).val();
                    var totalVentaNeta = $("#totalVentaNeta_" + id).val();
                    var totalFactura = $("#totalFactura_" + id).val();	
                    var codMoneda = parseInt($("#codMoneda").val());
                    var tipoCambio = $("#tipoCambio").val();
                    var conversionImpuesto = parseFloat(0.00);

                    console.log(precio + monedaActual);

                    if (monedaActual === "1") {

                        if (codMoneda === 1) {
                            //precio = parseFloat(precio);
                            //conversionImpuesto = parseFloat(impuestoTotal);
                        } else if (codMoneda === 2) {

                            precio = parseFloat(precio) / parseFloat($("#moneda2").val());
                            conversionImpuesto = parseFloat(impuestoTotal) / parseFloat($("#moneda2").val());
                            subTotal = parseFloat(subTotal) / parseFloat($("#moneda2").val());
                            totalLinea = parseFloat(totalLinea) / parseFloat($("#moneda2").val());
                            iva = parseFloat(iva) / parseFloat($("#moneda2").val());
                            montoExonerado = parseFloat(montoExonerado) / parseFloat($("#moneda2").val());
                            precioFraccion = parseFloat(precioFraccion) / parseFloat($("#moneda2").val());

                            totalServiciosGravados = parseFloat(totalServiciosGravados) / parseFloat($("#moneda2").val());
                            totalServiciosExentos = parseFloat(totalServiciosExentos) / parseFloat($("#moneda2").val());
                            totalServExonerado = parseFloat(totalServExonerado) / parseFloat($("#moneda2").val());
                            totalMercanciaGravadas = parseFloat(totalMercanciaGravadas) / parseFloat($("#moneda2").val());
                            totalMercanciasExentas = parseFloat(totalMercanciasExentas) / parseFloat($("#moneda2").val());
                            totalMercExonerada = parseFloat(totalMercExonerada) / parseFloat($("#moneda2").val());
                            totalGravados = parseFloat(totalGravados) / parseFloat($("#moneda2").val());
                            totalExentos = parseFloat(totalExentos) / parseFloat($("#moneda2").val());
                            totalExonerado = parseFloat(totalExonerado) / parseFloat($("#moneda2").val());
                            totalVenta = parseFloat(totalVenta) / parseFloat($("#moneda2").val());
                            totalVentaNeta = parseFloat(totalVentaNeta) / parseFloat($("#moneda2").val());
                            totalFactura = parseFloat(totalFactura) / parseFloat($("#moneda2").val());

                        } else {

                            precio = parseFloat(precio) / parseFloat($("#moneda3").val());
                            conversionImpuesto = parseFloat(impuestoTotal) / parseFloat($("#moneda3").val());
                            subTotal = parseFloat(subTotal) / parseFloat($("#moneda3").val());
                            totalLinea = parseFloat(totalLinea) / parseFloat($("#moneda3").val());
                            iva = parseFloat(iva) / parseFloat($("#moneda3").val());
                            montoExonerado = parseFloat(montoExonerado) / parseFloat($("#moneda3").val());
                            precioFraccion = parseFloat(precioFraccion) / parseFloat($("#moneda3").val());

                            totalServiciosGravados = parseFloat(totalServiciosGravados) / parseFloat($("#moneda3").val());
                            totalServiciosExentos = parseFloat(totalServiciosExentos) / parseFloat($("#moneda3").val());
                            totalServExonerado = parseFloat(totalServExonerado) / parseFloat($("#moneda3").val());
                            totalMercanciaGravadas = parseFloat(totalMercanciaGravadas) / parseFloat($("#moneda3").val());
                            totalMercanciasExentas = parseFloat(totalMercanciasExentas) / parseFloat($("#moneda3").val());
                            totalMercExonerada = parseFloat(totalMercExonerada) / parseFloat($("#moneda3").val());
                            totalGravados = parseFloat(totalGravados) / parseFloat($("#moneda3").val());
                            totalExentos = parseFloat(totalExentos) / parseFloat($("#moneda3").val());
                            totalExonerado = parseFloat(totalExonerado) / parseFloat($("#moneda3").val());
                            totalVenta = parseFloat(totalVenta) / parseFloat($("#moneda3").val());
                            totalVentaNeta = parseFloat(totalVentaNeta) / parseFloat($("#moneda3").val());
                            totalFactura = parseFloat(totalFactura) / parseFloat($("#moneda3").val());

                        }

                    } else if (monedaActual === "2") {

                        if (codMoneda === 1) {
                            precio = parseFloat(precio) * parseFloat($("#moneda2").val());
                            conversionImpuesto = parseFloat(impuestoTotal) * parseFloat($("#moneda2").val());
                            subTotal = parseFloat(subTotal) * parseFloat($("#moneda2").val());
                            totalLinea = parseFloat(totalLinea) * parseFloat($("#moneda2").val());
                            iva = parseFloat(iva) * parseFloat($("#moneda2").val());
                            montoExonerado = parseFloat(montoExonerado) * parseFloat($("#moneda2").val());
                            precioFraccion = parseFloat(precioFraccion) * parseFloat($("#moneda2").val());

                            totalServiciosGravados = parseFloat(totalServiciosGravados) * parseFloat($("#moneda2").val());
                            totalServiciosExentos = parseFloat(totalServiciosExentos) * parseFloat($("#moneda2").val());
                            totalServExonerado = parseFloat(totalServExonerado) * parseFloat($("#moneda2").val());
                            totalMercanciaGravadas = parseFloat(totalMercanciaGravadas) * parseFloat($("#moneda2").val());
                            totalMercanciasExentas = parseFloat(totalMercanciasExentas) * parseFloat($("#moneda2").val());
                            totalMercExonerada = parseFloat(totalMercExonerada) * parseFloat($("#moneda2").val());
                            totalGravados = parseFloat(totalGravados) * parseFloat($("#moneda2").val());
                            totalExentos = parseFloat(totalExentos) * parseFloat($("#moneda2").val());
                            totalExonerado = parseFloat(totalExonerado) * parseFloat($("#moneda2").val());
                            totalVenta = parseFloat(totalVenta) * parseFloat($("#moneda2").val());
                            totalVentaNeta = parseFloat(totalVentaNeta) * parseFloat($("#moneda2").val());
                            totalFactura = parseFloat(totalFactura) * parseFloat($("#moneda2").val());

                        } else if (codMoneda === 2) {
                            //precio = parseFloat(precio);
                            //conversionImpuesto = parseFloat(impuestoTotal);
                        } else {
                            precio = parseFloat(precio) * parseFloat($("#moneda2").val()) / parseFloat($("#moneda3").val());
                            conversionImpuesto = parseFloat(impuestoTotal) * parseFloat($("#moneda2").val()) / parseFloat($("#moneda3").val());
                            subTotal = parseFloat(subTotal) * parseFloat($("#moneda2").val()) / parseFloat($("#moneda3").val());
                            totalLinea = parseFloat(totalLinea) * parseFloat($("#moneda2").val()) / parseFloat($("#moneda3").val());
                            iva = parseFloat(iva) * parseFloat($("#moneda2").val()) / parseFloat($("#moneda3").val());
                            montoExonerado = parseFloat(montoExonerado) * parseFloat($("#moneda2").val()) / parseFloat($("#moneda3").val());
                            precioFraccion = parseFloat(precioFraccion) * parseFloat($("#moneda2").val()) / parseFloat($("#moneda3").val());

                            totalServiciosGravados = parseFloat(totalServiciosGravados) * parseFloat($("#moneda2").val()) / parseFloat($("#moneda3").val());
                            totalServiciosExentos = parseFloat(totalServiciosExentos) * parseFloat($("#moneda2").val()) / parseFloat($("#moneda3").val());
                            totalServExonerado = parseFloat(totalServExonerado) * parseFloat($("#moneda2").val()) / parseFloat($("#moneda3").val());
                            totalMercanciaGravadas = parseFloat(totalMercanciaGravadas) * parseFloat($("#moneda2").val()) / parseFloat($("#moneda3").val());
                            totalMercanciasExentas = parseFloat(totalMercanciasExentas) * parseFloat($("#moneda2").val()) / parseFloat($("#moneda3").val());
                            totalMercExonerada = parseFloat(totalMercExonerada) * parseFloat($("#moneda2").val()) / parseFloat($("#moneda3").val());
                            totalGravados = parseFloat(totalGravados) * parseFloat($("#moneda2").val()) / parseFloat($("#moneda3").val());
                            totalExentos = parseFloat(totalExentos) * parseFloat($("#moneda2").val()) / parseFloat($("#moneda3").val());
                            totalExonerado = parseFloat(totalExonerado) * parseFloat($("#moneda2").val()) / parseFloat($("#moneda3").val());
                            totalVenta = parseFloat(totalVenta) * parseFloat($("#moneda2").val()) / parseFloat($("#moneda3").val());
                            totalVentaNeta = parseFloat(totalVentaNeta) * parseFloat($("#moneda2").val()) / parseFloat($("#moneda3").val());
                            totalFactura = parseFloat(totalFactura) * parseFloat($("#moneda2").val()) / parseFloat($("#moneda3").val());

                        }

                    } else if (monedaActual === "3") {

                        if (codMoneda === 1) {
                            precio = parseFloat(precio) * parseFloat($("#moneda3").val());
                            conversionImpuesto = parseFloat(impuestoTotal) * parseFloat($("#moneda3").val());
                            subTotal = parseFloat(subTotal) * parseFloat($("#moneda3").val());
                            totalLinea = parseFloat(totalLinea) * parseFloat($("#moneda3").val());
                            iva = parseFloat(totalLinea) * parseFloat($("#moneda3").val());
                            montoExonerado = parseFloat(montoExonerado) * parseFloat($("#moneda3").val());
                            precioFraccion = parseFloat(precioFraccion) * parseFloat($("#moneda3").val());

                            totalServiciosGravados = parseFloat(totalServiciosGravados) * parseFloat($("#moneda3").val());
                            totalServiciosExentos = parseFloat(totalServiciosExentos) * parseFloat($("#moneda3").val());
                            totalServExonerado = parseFloat(totalServExonerado) * parseFloat($("#moneda3").val());
                            totalMercanciaGravadas = parseFloat(totalMercanciaGravadas) * parseFloat($("#moneda3").val());
                            totalMercanciasExentas = parseFloat(totalMercanciasExentas) * parseFloat($("#moneda3").val());
                            totalMercExonerada = parseFloat(totalMercExonerada) * parseFloat($("#moneda3").val());
                            totalGravados = parseFloat(totalGravados) * parseFloat($("#moneda3").val());
                            totalExentos = parseFloat(totalExentos) * parseFloat($("#moneda3").val());
                            totalExonerado = parseFloat(totalExonerado) * parseFloat($("#moneda3").val());
                            totalVenta = parseFloat(totalVenta) * parseFloat($("#moneda3").val());
                            totalVentaNeta = parseFloat(totalVentaNeta) * parseFloat($("#moneda3").val());
                            totalFactura = parseFloat(totalFactura) * parseFloat($("#moneda3").val());

                        } else if (codMoneda === 2) {

                            precio = parseFloat(precio) * parseFloat($("#moneda3").val()) / parseFloat($("#moneda2").val());
                            conversionImpuesto = parseFloat(impuestoTotal) * parseFloat($("#moneda3").val()) / parseFloat($("#moneda2").val());
                            subTotal = parseFloat(subTotal) * parseFloat($("#moneda3").val()) / parseFloat($("#moneda2").val());
                            totalLinea = parseFloat(subTotal) * parseFloat($("#moneda3").val()) / parseFloat($("#moneda2").val());
                            iva = parseFloat(subTotal) * parseFloat($("#moneda3").val()) / parseFloat($("#moneda2").val());
                            montoExonerado = parseFloat(montoExonerado) * parseFloat($("#moneda3").val()) / parseFloat($("#moneda2").val());
                            precioFraccion = parseFloat(precioFraccion) * parseFloat($("#moneda3").val());

                            totalServiciosGravados = parseFloat(totalServiciosGravados) * parseFloat($("#moneda3").val()) / parseFloat($("#moneda2").val());
                            totalServiciosExentos = parseFloat(totalServiciosExentos) * parseFloat($("#moneda3").val()) / parseFloat($("#moneda2").val());
                            totalServExonerado = parseFloat(totalServExonerado) * parseFloat($("#moneda3").val()) / parseFloat($("#moneda2").val());
                            totalMercanciaGravadas = parseFloat(totalMercanciaGravadas) * parseFloat($("#moneda3").val()) / parseFloat($("#moneda2").val());
                            totalMercanciasExentas = parseFloat(totalMercanciasExentas) * parseFloat($("#moneda3").val()) / parseFloat($("#moneda2").val());
                            totalMercExonerada = parseFloat(totalMercExonerada) * parseFloat($("#moneda3").val()) / parseFloat($("#moneda2").val());
                            totalGravados = parseFloat(totalGravados) * parseFloat($("#moneda3").val()) / parseFloat($("#moneda2").val());
                            totalExentos = parseFloat(totalExentos) * parseFloat($("#moneda3").val()) / parseFloat($("#moneda2").val());
                            totalExonerado = parseFloat(totalExonerado) * parseFloat($("#moneda3").val()) / parseFloat($("#moneda2").val());
                            totalVenta = parseFloat(totalVenta) * parseFloat($("#moneda3").val()) / parseFloat($("#moneda2").val());
                            totalVentaNeta = parseFloat(totalVentaNeta) * parseFloat($("#moneda3").val()) / parseFloat($("#moneda2").val());
                            totalFactura = parseFloat(totalFactura) * parseFloat($("#moneda3").val()) / parseFloat($("#moneda2").val());

                        } else {
                            //precio = parseFloat(precio);
                            //conversionImpuesto = parseFloat(impuestoTotal);
                        }

                    }

                    console.log("conversionImpuesto" + conversionImpuesto);

                    $("#moneda_" + id).val(codMoneda);
                    $("#precio_" + id).val(toFixed(precio, decimales));
                    $("#subtotal_" + id).val(toFixed(subTotal, decimales));
                    $("#impuesto_total_" + id).val(toFixed(conversionImpuesto, decimales));
                    $("#exonera2" + id + "1").val(toFixed(iva, decimales));
                    $("#exonera4" + id + "1").val(toFixed(montoExonerado, decimales));
                    $("#total_importe_" + id).val(toFixed(totalLinea, decimales));
                    $("#precioFraccion_" + id).val(toFixed(precioFraccion, decimales));

                    $("#totalServiciosGravados_" + id).val(toFixed(totalServiciosGravados, decimales));
                    $("#totalServiciosExentos_" + id).val(toFixed(totalServiciosExentos, decimales));
                    $("#totalServExonerado_" + id).val(toFixed(totalServExonerado, decimales));
                    $("#totalMercanciaGravadas_" + id).val(toFixed(totalMercanciaGravadas, decimales));
                    $("#totalMercanciasExentas_" + id).val(toFixed(totalMercanciasExentas, decimales));
                    $("#totalMercExonerada_" + id).val(toFixed(totalMercExonerada, decimales));
                    $("#totalGravados_" + id).val(toFixed(totalGravados, decimales));
                    $("#totalExentos_" + id).val(toFixed(totalExentos, decimales));
                    $("#totalExonerado_" + id).val(toFixed(totalExonerado, decimales));
                    $("#totalVenta_" + id).val(toFixed(totalVenta, decimales));
                    $("#totalVentaNeta_" + id).val(toFixed(totalVentaNeta, decimales));
                    $("#totalFactura_" + id).val(toFixed(totalFactura, decimales));

                    itemsHelper.calcularImporte(id, precio, impuesto, condProducto, cantidad, descuento, unidadDeMedida);


                }


            });
        }

        $(document).on("click", ".btn-delete-row", function (e) {

            e.preventDefault();

            if ($("#tipoDocumento").val() === "PR") {

                var id = 0;
                try {
                    id = $(this).attr("data-id");
                } catch (e) {
                    id = 0;
                }

                $.ajax({
                    type: "POST",
                    cache: false,
                    beforeSend: function () { },
                    url: "[(@{/proformas/delete-item})]",
                    data: { id: id, _csrf: token },
                    success: function (data) {
                        guardarProforma();
                    }, complete: function () {
                        //loading_hide();
                    }, error: function (x, t, m) {
                        if (t === "timeout") {

                        } else {

                        }

                        guardarProforma();

                    }
                });

            }

        });

        $(document).on("click", ".btn-change-impuesto", function (e) {
            e.preventDefault();

            var p = $(this).attr("data-p");
            var imp = $(this).attr("data-i");
            var ti = $(this).attr("data-t");

            $("#tipoImpuesto").val(imp);
            $("#tarifaImpuesto").val(ti);

            $("#_productoId").val(p);
            $("#_impuestoId").val(imp);
            $("#_tarifaImpuestoId").val(ti);

        });

        $(document).on("click", "#btnAplicarImpuesto", function (e) {

            e.preventDefault();

            //Obtengo el id del producto, el id del impuesto y el id de la tarifa
            var productoId = $("#_productoId").val();
            var impuestoId = $("#_impuestoId").val();
            var tarifaImpuestoId = $("#_tarifaImpuestoId").val();

            //Obtengo el valor del nuevo impuesto
            var valImpuesto = $("#tipoImpuesto").val();
            var labelImpuesto = $("#tipoImpuesto").find(':selected').data('di');

            //Obtengo la nueva tarifa
            var valTarifaImpuesto = $("#tarifaImpuesto").val();
            //var valTarifaImpuesto = $("#tarifaImpuesto").find(':selected').data('value');
            var tarifa = $("#tarifaImpuesto").find(':selected').data('tarifa');
            
            var precio = $("#precio_" + productoId).val();
            var cantidad = $("#cantidad_" + productoId).val();
            var impuesto = $("#impuesto_" + productoId).val();
            //var montoExonerado = $("#exonera4" + productoId + "1").val();
            var condProducto = $("#_condicionProducto" + productoId).val();
            var descuento = $("#descuento_" + productoId).val();
            var unidadDeMedida = $("#_unidadDeMedida" + productoId).val();

            //Asigno la nueva tarifa seleccionada y también su etiqueta
            $("#_impuestoTarifaIva" + productoId + tarifaImpuestoId).val("0" + valTarifaImpuesto);
            $("#_impuestosDetalle" + productoId + impuestoId).val(labelImpuesto);

            //Modifico los Ids por por si vuelven a actualizar
            $("#_impuestoTarifaIva" + productoId + tarifaImpuestoId).attr("id", "_impuestoTarifaIva" + productoId + valTarifaImpuesto);
            $("#_impuestosDetalle" + productoId + impuestoId).attr("id", "_impuestosDetalle" + productoId + valTarifaImpuesto);

            //Modifico la etiqueta del nuevo impuesto
            $("#_impuestosDetalle" + productoId + valTarifaImpuesto).val(labelImpuesto);

            //Modifico valores, tarifa y atributos
            $('input[id^="exonera1'+productoId).val(tarifa);
            $('input[id^="exonera1'+productoId).attr("data-i", tarifa);
            $('input[id^="exonera2'+productoId).attr("data-tarifa", tarifa);
            $("#impuestosId" + productoId).val(valImpuesto);

            //Modifico el boton de modificar impuesto
            $("#btn-change-impuesto" + productoId + impuestoId + tarifa).attr("data-p", productoId);
            $("#btn-change-impuesto" + productoId + impuestoId + tarifa).attr("data-i", valImpuesto);
            $("#btn-change-impuesto" + productoId + impuestoId + tarifaImpuestoId).attr("data-t", valTarifaImpuesto);
            
            console.log("valTarifaImpuesto " + valTarifaImpuesto);

            //Cambio el id del boton de modificar impuesto con el nuevo valor para el id
            $("#btn-change-impuesto" + productoId + impuestoId).attr("id", "btn-change-impuesto" + productoId + valTarifaImpuesto);
            $("#exonera1" + productoId + impuestoId).attr("id", "exonera1" + productoId + valTarifaImpuesto);

            //Obtengo el impuesto
            var impuesto = $("#impuesto_" + productoId).val();

            //Caludo la linea con los nuevo datos
            itemsHelper.calcularImporte(productoId, precio, impuesto, condProducto, cantidad, descuento, unidadDeMedida);

            swal("Éxito", "El impuesto se modifico con éxito", "success");


            //Si es una proforma guardo la factura
            if ($("#tipoDocumento").val() === "PR") {
                guardarProforma();
            }

        });

        function removeAsignacionMedioPago() {
            $("#modalPagar .customtab .nav-link").removeClass("active");
            $("#modalPagar .tab-content .tab-pane").removeClass("active");
        }

        function asignaTipoPago() {

            //Elimino la clase active
            removeAsignacionMedioPago()

            var v = $("#codMoneda").val();

            switch (parseInt(v)) {
                case 1:
                    $(".pago-colones").addClass("active");
                    $("#colones").addClass("active");
                    $(".medioPago").focus();
                    break;
                case 2:
                    $(".pago-dolares").addClass("active");
                    $("#dolares").addClass("active");
                    $(".medioPagoDolar").focus();
                    break;
                case 3:
                    $(".pago-euros").addClass("active");
                    $("#euros").addClass("active");
                    $(".medioPagoDolar").focus();
                    break;
                default:
                    break;
            }
        }

        //Apenas cargo la pagina lo ejecuto
        asignaTipoPago();
        
        /*
        $(document).on("input", ".porcentajeOtrosCargos", function(){
        	
        	var j = $(this).val();
        	if(parseFloat(j) > 0){
	        	var a = 0;	        	
	        	var m = "";
	        	var d = $("#totalVentaSumary").val();
	        	
	        	if(j < 10 ){
	        		m = "0.";
	        	}else if(j > 10  && j < 99){
	        		m = "1.";
	        	}else{
	        		m = "";
	        	}
	        	
	        	console.log("mmmm " + m);
	        	
	        	var a = (parseFloat(d) * parseFloat( m+''+j )) - parseFloat(d);
	        	$("#otrosCargosMontoCargo" + $(this).attr("data-id")).val( a );
        	}
        	
        });
        */
        
        function convertDate(inputFormat) {
       	  function pad(s) { return (s < 10) ? '0' + s : s; }
       	  var d = new Date(inputFormat)
       	  return [pad(d.getDate()), pad(d.getMonth()+1), d.getFullYear()].join('/')
       	}
        
        $(document).on("keyup","#numeroDocumento", function(e){
            
            e.preventDefault();
            if($(this).val().length >= 13){

                $.ajax({
                    type: "GET",
                    //cache: false,
                    beforeSend: function () {
                        loadingShow();
                    },
                    url: "https://api.hacienda.go.cr/fe/ex",
                    data: {autorizacion: $(this).val()},
                    success: function (data)
                    {
                    	
                      var codigoExonera = data.tipoDocumento.codigo;
                    	
                      $("#tipoDocumentoExoneracionOAutorizacion").val(codigoExonera.substring(1,2));

                      $("#nombreInstitucion").val(data.nombreInstitucion);
                      $("#porcentajeExoneracion").val(data.porcentajeExoneracion);
                      
                      $("#fechaInicioExoneracion").val(convertDate(data.fechaEmision));
                      $("#fechaFinExoneracion").val(convertDate(data.fechaVencimiento));
                      
                      setTimeout(function(){
                    	  $("#tipoDocumentoExoneracionOAutorizacion").select2();
                      },100);
                      
                    }, complete: function () {
                        loadingHide();
                    }, error: function (x, t, m) {

                        if (t === "timeout") {
                            
                        } else {
                            
                        }
                    }
                });
            
            }
            
      });
        
        $(document).on("input", ".input-exoneracion", function(){        	
        	var j = $('input[id^="exonera1'+$(this).attr("data-producto")).attr("data-i");
        	var v = $(this).val();
        	if(parseFloat(v) > j){
        		swal("Notificación", "El porcentaje de exoneración no puede ser mayor al porcentaje del impuesto asignado al producto en este caso la tarifa es "+j+"", "warning");
        		$(this).val("");
        	}
        })

        $('.number-format').number(true, [(${ session.SESSION_DECIMALES })], '.', ' ');
        
    </script>
</body>

</html>