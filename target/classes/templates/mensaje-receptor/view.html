<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="layout/layout :: head"></head>
<body class="fix-header card-no-border logo-center">

<div id="main-wrapper">

<header th:replace="layout/layout :: header"></header>
<aside th:replace="layout/layout :: aside"></aside>

<!-- ============================================================== -->
<!-- Page wrapper  -->
<!-- ============================================================== -->
<div class="page-wrapper">
    <!-- ============================================================== -->
    <!-- Bread crumb and right sidebar toggle -->
    <!-- ============================================================== -->
    <div class="row page-titles">
        <div class="col-md-5 align-self-center">
            <h3 class="text-themecolor" th:text="#{txt.mensaje.receptor}"></h3>
        </div>
        <div class="col-md-7 align-self-center">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="javascript:void(0)" th:href="@{/mensaje-receptor/}" th:text="#{txt.inicio}"></a></li>
                <li class="breadcrumb-item active" th:text="#{txt.mensaje.receptor}"></li>
            </ol>
        </div>
    </div>
    <!-- ============================================================== -->
    <!-- End Bread crumb and right sidebar toggle -->
    <!-- ============================================================== -->
    <!-- ============================================================== -->
    <!-- Container fluid  -->
    <!-- ============================================================== -->
    <div class="container-fluid">
        <!-- ============================================================== -->
        <!-- Start Page Content -->
        <!-- ============================================================== -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">

                    	<form method="post" id="formAddMensajeReceptor" th:object="${mensajeReceptor}" th:action="@{/mensaje-receptor/recepcion}">
                    	
                    			<h4 class="card-title">Datos del documento enviado</h4>
		                          <hr>
		                          
		                          <div class="row">
		                          		<div class="col-md-4">
		                          			<div class="form-group">
		                                           <label class="control-label">Clave</label>
		                                           <input readonly="readonly" th:field="*{claveGenerada}" class="form-control">
		                                    </div>
		                          		</div>
		                          		<div class="col-md-4">
		                          			<div class="form-group">
		                                           <label class="control-label">Consecutivo</label>
		                                           <input readonly="readonly" th:field="*{consecutivoGenerado}" class="form-control">
		                                    </div>
		                          		</div>
		                          		<div class="col-md-4">
		                          			<div class="form-group">
		                                           <label class="control-label">Fecha emisión</label>
		                                           
		                                           <input readonly="readonly" th:field="*{fechaEmisionGenerado}" class="form-control">
		                                    </div>
		                          		</div>
		                          		<div th:if="${mensajeReceptor.fechaAceptacion != null}"  class="col-md-4">
		                          			<div class="form-group">
		                                           <label class="control-label">Fecha aceptación</label>
		                                           <input readonly="readonly" th:field="*{fechaAceptacion}" class="form-control">
		                                    </div>
		                          		</div>
		                          		<div th:if="${mensajeReceptor.estadoHacienda != null}"  class="col-md-4">
		                          			<div class="form-group">
		                                           <label class="control-label">Estado hacienda</label>
		                                           <input readonly="readonly" th:field="*{estadoHacienda}" class="form-control">
		                                    </div>
		                          		</div>
		                          		<div class="col-md-12">
		                          			<div class="form-group">
		                                          <a class="btn btn-success btn-sm" style="color:#FFF !important;" th:href="${urlApiDownloadXml} + ${identificacionEmpresa} + '/' + ${mensajeReceptor.fileXmlSign}">
		                                          	<i class="fas fa-cloud-download-alt"></i> Descargar XML enviado
		                                          </a>
		                                          <a th:if="${mensajeReceptor.fileXmlAceptacion != null and #strings.length(mensajeReceptor.fileXmlAceptacion)>0}" class="btn btn-success btn-sm" style="color:#FFF !important;" th:href="${urlApiDownloadXml} + ${identificacionEmpresa} + '/' + ${mensajeReceptor.fileXmlAceptacion}">
		                                          	<i class="fas fa-cloud-download-alt"></i> Descargar XML respuesta MH
		                                          </a>
		                                    </div>
		                          		</div>
		                          </div>		
		                          
		                          <h4 class="card-title">Resumen del emisor</h4>
		                          <hr>
		                               
		                          <div class="row">
		                          		<div class="col-md-4">
		                          			<div class="form-group">
		                                           <label class="control-label">Nombre Emisor</label>
		                                           <input readonly="readonly" th:field="*{emisorMr}" class="form-control">
		                                       </div>
		                          		</div>
		                          		<div class="col-md-4">
		                          			<div class="form-group">
		                                           <label class="control-label">Nombre Comercial Emisor</label>
		                                           <input readonly="readonly" th:field="*{nombreComercialEmisorMr}" class="form-control">
		                                       </div>
		                          		</div>
		                          		<div class="col-md-4">
		                          			<div class="form-group">
		                                           <label class="control-label">Correo</label>
		                                           <input readonly="readonly" th:field="*{correoEmisorMr}" class="form-control">
		                                       </div>
		                          		</div>
		                          		<div class="col-md-4">
		                          			<div class="form-group">
		                                           <label class="control-label">Tipo cédula emisor</label>
		                                           <input readonly="readonly" th:field="*{tipoIdentificacionEmisorMr}" class="form-control">
		                                       </div>
		                          		</div>
		                          		<div class="col-md-4">
		                          			<div class="form-group">
		                                           <label class="control-label">Cédula emisor</label>
		                                           <input readonly="readonly" th:field="*{identificacionEmisorMr}" class="form-control">
		                                       </div>
		                          		</div>
		                          		
		                          </div> 
		                          
		                          <h4 class="card-title">Resumen de Receptor</h4>
		                          <hr>    
		                          
		                          <div class="row">
		                          		<div class="col-md-4">
		                          			<div class="form-group">
		                                           <label class="control-label">Nombre receptor</label>
		                                           <input readonly="readonly" th:field="*{nombreReceptorMr}" class="form-control">
		                                       </div>
		                          		</div>
		                          		<div class="col-md-4">
		                          			<div class="form-group">
		                                           <label class="control-label">Nombre comercial receptor</label>
		                                           <input readonly="readonly" th:field="*{nombreComercialReceptorMr}" class="form-control">
		                                       </div>
		                          		</div>
		                          		<div class="col-md-4">
		                          			<div class="form-group">
		                                           <label class="control-label">Tipo cédula receptor</label>
		                                           <input readonly="readonly" th:field="*{tipoIdentificacionReceptorMr}" class="form-control">
		                                       </div>
		                          		</div>
		                          		<div class="col-md-4">
		                          			<div class="form-group">
		                                           <label class="control-label">Cédula del receptor</label>
		                                           <input readonly="readonly" th:field="*{identificacionReceptorMr}" class="form-control">
		                                       </div>
		                          		</div>
		                          		
		                          </div>
		                          
		                          
		                          
		                          <div class="row">
		                          	<div class="col-sm-12 col-md-10">
		                          		<h4 class="card-title">Lineas de la factura</h4>
		                          	</div>
		                          	<div class="col-sm-12 col-md-2">
		                          		<button th:if="${mensajeReceptor.estadoInventario != 'A'}" th:attr="data-id=${mensajeReceptor.id}" id="btnFinalizaFactura" class="btn btn-xs btn-block btn-success">
		                          			<i class="fas fa-check"></i> Marcar como aplicado
		                          		</button>
		                          	</div>
		                          </div>
		                          <hr>
		                          <div class="table-responsive">
		                          <table class="table color-table table-hover muted-table">
		                          	<thead>
		                          		<tr>
		                          			<th style="width: 15%">Código interno</th>
		                          			<th>Cantidad</th>		                          			
		                          			<th style="width: 8%">Precio compra</th>		                          			
		                          			<th style="width: 5%">Utilidad</th>
		                          			<th th:style="${TIPO_VENTA == 'A' ? 'display:none' : 'display:table-cell;width:8%'}">Utilidad f</th>
		                          			<th style="width: 8%">Precio actual</th>
		                          			<th style="width: 4%">Aplicar desc.</th>
		                          			<th style="width: 8%">Precio venta <br> sin IVA</th>
		                          			<th th:style="${TIPO_VENTA == 'A' ? 'display:none' : 'display:table-cell;width:8%'}">Precio venta fracción <br> sin IVA</th>
		                          			<th style="width: 8%">M. total</th>		                          			
		                          			<th style="width: 5%">Desc.</th>
		                          			<th style="width: 5%">Subt</th>
		                          			<th style="width: 5%">IVA</th>
		                          			<th style="width: 8%">M. total linea</th>
		                          			<th style="width: 5%">Acciones</th>
		                          		</tr>
		                          	</thead>
		                          	<tbody>
		                          		<tr th:id="'row-'+${k.id}" th:each="k : ${mensajeReceptor.items}" th:classappend="${#strings.equals(k.estadoInventarioLinea,'A')} ? table-success : ''" >

		                          			<td>
		                          			
		                          				[(${k.detalleProducto})]
		                          				<input th:readonly="${#strings.equals(k.estadoInventarioLinea,'A')}" autocomplete="off" onclick="return this.select();" type="text" size="100"  th:id="'i-codigo-id-' + ${k.id}" th:attr="data-id=${k.id}" class="form-control search-products"/>
		                          				<input type="hidden" th:id="'h-codigo-id-' + ${k.id}" class="form-control hidden-search-products"/>

		                          			</td>
		                          			
		                          			<td>
		                          				[(${#numbers.formatDecimal(k.cantidad, 0, 'POINT', 2, 'COMMA')})]
		                          				<input type="hidden" th:value="${k.cantidad}" th:id="'i-cantidad-id-' + ${k.id}" />
		                          			</td>
		                          			
		                          			<td th:text="${#numbers.formatDecimal(k.precioUnitario, 0, 'POINT', 2, 'COMMA')}"></td>
		                          			
		                          			<td>
		                          				<input th:readonly="${#strings.equals(k.estadoInventarioLinea,'A')}" onclick="return this.select();" class="form-control number-format calcula-precio-final" th:value="${k.utilidad}" th:attr="data-l=${k.id}" th:id="'i-utilidad-id-' + ${k.id}" type="text" size="4"/>
		                          			</td>
		                          			<td th:style="${TIPO_VENTA == 'A' ? 'display:none' : 'display:table-cell'}">
		                          				<input th:readonly="${#strings.equals(k.estadoInventarioLinea,'A')}" onclick="return this.select();" class="form-control number-format calcula-precio-fraccion" th:value="${k.utilidadFraccion}" th:attr="data-l=${k.id}" th:id="'i-utilidad-f-id-' + ${k.id}" type="text" size="4"/>
		                          				<input class="form-control" th:id="'i-tipo-venta-id-' + ${k.id}" type="hidden" size="4"/>
		                          				<input class="form-control" th:id="'i-fracciones-unidad-id-' + ${k.id}" type="hidden" size="4"/>
		                          			</td>
		                          			
		                          			<td>
		                          				<input readonly="readonly" th:value="${k.precioActualCatalogo}" class="form-control number-format" th:id="'i-precio-actual-sin-iva-id-' + ${k.id}" size="41" type="text"/>
		                          			</td>
		                          			
		                          			<td>
		                          				<input th:if="${k.estadoInventarioLinea != 'A'}" th:attr="onchange=|aplicaOmiteDescuento(${k.id})|" th:value="${k.precioActualCatalogo}" class="form-control number-format" th:id="'i-aplica-desc-linea-id-' + ${k.id}" type="checkbox"/>
		                          			</td>
		                          			
		                          			<td>
		                          				<input class="form-control" th:id="'i-precio-compra-' + ${k.id}" type="hidden"/>
		                          				<input th:readonly="${#strings.equals(k.estadoInventarioLinea,'A')}" onclick="return this.select();" class="form-control number-format calcula-utilidad" th:attr="data-l=${k.id}" th:value="${k.precioVentaSinIva}" th:id="'i-precio-venta-sin-iva-id-' + ${k.id}" size="41" type="text"/>
		                          			</td>
		                          			
		                          			<td th:style="${TIPO_VENTA == 'A' ? 'display:none' : 'display:block'}">
		                          				<input th:readonly="${#strings.equals(k.estadoInventarioLinea,'A')}" onclick="return this.select();" class="form-control calcula-utilidad-fraccion number-format" th:value="${k.precioVentaFraccionSinIva}" th:attr="data-l=${k.id}" th:id="'i-precio-venta-fraccion-sin-iva-id-' + ${k.id}" size="41" type="text"/>
		                          			</td>
		                          			
		                          			<td>
		                          				[(${#numbers.formatDecimal(k.montoTotal, 0, 'POINT', 2, 'COMMA')})]
		                          				<input th:id="'i-monto-total-' + ${k.id}" type="hidden" th:value="${k.montoTotal}"/>

		                          				<input th:id="'i-monto-total-linea-aplicar-' + ${k.id}" th:value="${k.montoTotal}" type="hidden"/>
		                          			</td>
		                          			<td>
		                          				<input th:id="'i-monto-descuento-' + ${k.id}" type="hidden" th:value="${#numbers.formatDecimal(k.montoDescuento, 0, 'POINT', 2, 'COMMA')}"/>	
		                          				[(${#numbers.formatDecimal(k.montoDescuento, 0, 'POINT', 2, 'COMMA')})]
		                          			</td>
		                          			
		                          			
		                          			<td>
		                          				<input th:id="'i-sub-total-' + ${k.id}" type="hidden" th:value="${k.subTotal}"/>
		                          				[(${#numbers.formatDecimal(k.subTotal, 0, 'POINT', 2, 'COMMA')})]
		                          			</td>
		                          					                          			
		                          			<td>
		                          				<input type="hidden" th:value="${k.totalImpuestos}" th:id="'i-total-impuestos-id-' + ${k.id}" />
		                          				[(${#numbers.formatDecimal(k.totalImpuestos, 0, 'POINT', 2, 'COMMA')})]
		                          			</td>
		                          			
		                          			<td th:text="${#numbers.formatDecimal(k.montoTotalLinea, 0, 'POINT', 2, 'COMMA')}"></td>
		                          			
		                          			<td>
		                          				<button th:if="${k.estadoInventarioLinea != 'A'}" type="button" th:id="'btn-aplicar-linea' + ${k.id}" class="btn btn-xs btn-success btn-aplicar-linea" th:attr="data-id=${k.id}">
		                          					<i class="fas fa-plus"></i> Aplicar a <br>inventario
		                          				</button>
		                          			</td>
		                          		</tr>
		                          	</tbody>
		                          </table>
		                          </div>
		                          
		                          <h4 class="card-title">Condición de la venta</h4>
		                          <hr>
		                          
		                          <div class="row">
		                          	<div class="col-md-2">
	                          			<div class="form-group">
	                                           <label class="control-label">Condión venta</label>
	                                           <input readonly="readonly" th:field="*{condicionVenta}" class="form-control">
	                                       </div>
	                          		</div>
	                          		<div class="col-md-2">
	                          			<div class="form-group">
	                                           <label class="control-label">Plazo crédito</label>
	                                           <input readonly="readonly" th:field="*{plazoCredito}" class="form-control">
	                                       </div>
	                          		</div>
	                          		<div class="col-md-2">
	                          			<div class="form-group">
                                           <label class="control-label">Medio de pago</label>
                                           <input readonly="readonly" th:field="*{medioPago}" class="form-control">
                                        </div>
	                          		</div>
		                          </div>
		                          
		                          <h4 class="card-title">Resumen de Factura</h4>
		                          <hr>
		
		  						<div class="row">
		  							<div class="col-md-2">
		                          		<div class="form-group">
                                           <label class="control-label">[(#{txt.codigo.actividad})]</label>
                                           <input readonly="readonly" th:field="*{codigoActividad}" class="form-control">
                                        </div>
	                          		</div>
		  							<div class="col-md-4">
		                          		<div class="form-group">
                                           <label class="control-label">[(#{txt.clave})]</label>
                                           <input readonly="readonly" th:field="*{clave}" class="form-control">
                                        </div>
	                          		</div>
	                          		<div class="col-md-2">
	                          			<div class="form-group">
                                           <label class="control-label">[(#{txt.moneda})]</label>
                                           <input readonly="readonly" th:field="*{moneda}" class="form-control">
                                        </div>
	                          		</div>
	                          		<div class="col-md-2">
	                          			<div class="form-group">
                                           <label class="control-label">Tipo cambio</label>
                                           <input readonly="readonly" th:field="*{tipoCambio}" class="form-control">
                                        </div>
	                          		</div>
	                          		<div class="col-md-2">
	                          			<div class="form-group">
                                           <label class="control-label">[(#{txt.fecha.de.emision})]</label>
                                           <input readonly="readonly" th:field="*{fechaEmision}" class="form-control">
                                        </div>
	                          		</div>
	                          		
	                          		
	                          		<div class="col-md-2">
	                          			 <div class="form-group">
                                           <label class="control-label">Total serv gravados</label>
                                           <input readonly="readonly" th:field="*{totalServGravados}" class="datepicker-disabled form-control">
                                         </div>
	                          		</div>
	                          		<div class="col-md-2">
	                          			 <div class="form-group">
                                           <label class="control-label">Total serv exentos</label>
                                           <input readonly="readonly" th:field="*{totalServExentos}" class="datepicker-disabled form-control">
                                         </div>
	                          		</div>
	                          		<div class="col-md-2">
	                          			 <div class="form-group">
                                           <label class="control-label">Total serv exonerado</label>
                                           <input readonly="readonly" th:field="*{totalServExonerado}" class="datepicker-disabled form-control">
                                         </div>
	                          		</div>
	                          		<div class="col-md-2">
	                          			 <div class="form-group">
                                           <label class="control-label">Total merc gravadas</label>
                                           <input readonly="readonly" th:field="*{totalMercGravadas}" class="datepicker-disabled form-control">
                                         </div>
	                          		</div>
	                          		<div class="col-md-2">
	                          			 <div class="form-group">
                                           <label class="control-label">Total merc exentas</label>
                                           <input readonly="readonly" th:field="*{totalMercExentas}" class="datepicker-disabled form-control">
                                         </div>
	                          		</div>
	                          		<div class="col-md-2">
	                          			 <div class="form-group">
                                           <label class="control-label">Total merc exonerada</label>
                                           <input readonly="readonly" th:field="*{totalMercExonerada}" class="datepicker-disabled form-control">
                                         </div>
	                          		</div>
	                          		<div class="col-md-2">
	                          			 <div class="form-group">
                                           <label class="control-label">Total gravado</label>
                                           <input readonly="readonly" th:field="*{totalGravados}" class="datepicker-disabled form-control">
                                         </div>
	                          		</div>
	                          		
	                          		<div class="col-md-2">
	                          			 <div class="form-group">
                                           <label class="control-label">Total exento</label>
                                           <input readonly="readonly" th:field="*{totalExentos}" class="datepicker-disabled form-control">
                                         </div>
	                          		</div>
	                          		
	                          		<div class="col-md-2">
	                          			 <div class="form-group">
                                           <label class="control-label">Total exonerado</label>
                                           <input readonly="readonly" th:field="*{totalExonerado}" class="datepicker-disabled form-control">
                                         </div>
	                          		</div>
	                          		
	                          		<div class="col-md-2">
	                          			 <div class="form-group">
                                           <label class="control-label">Total venta</label>
                                           <input readonly="readonly" th:field="*{totalVentas}" class="datepicker-disabled form-control">
                                         </div>
	                          		</div>
	                          		
	                          		<div class="col-md-2">
	                          			 <div class="form-group">
                                           <label class="control-label">Total descuentos</label>
                                           <input readonly="readonly" th:field="*{totalDescuentos}" class="datepicker-disabled form-control">
                                         </div>
	                          		</div>
	                          		
	                          		<div class="col-md-2">
	                          			 <div class="form-group">
                                           <label class="control-label">Total venta neta</label>
                                           <input readonly="readonly" th:field="*{totalVentaNeta}" class="datepicker-disabled form-control">
                                         </div>
	                          		</div>
	                          		
	                          		<div class="col-md-2">
	                          			 <div class="form-group">
                                           <label class="control-label">[(#{txt.impuestos})]</label>
                                           <input readonly="readonly" th:field="*{impuestos}" class="datepicker-disabled form-control">
                                         </div>
	                          		</div>
	                          		
	                          		<div class="col-md-2">
	                          			 <div class="form-group">
                                           <label class="control-label">Total IVA devuelto</label>
                                           <input readonly="readonly" th:field="*{totalIVADevuelto}" class="datepicker-disabled form-control">
                                         </div>
	                          		</div>
	                          		
	                          		<div class="col-md-2">
	                          			 <div class="form-group">
                                           <label class="control-label">Total otros cargos</label>
                                           <input readonly="readonly" th:field="*{totalOtrosCargos}" class="datepicker-disabled form-control">
                                         </div>
	                          		</div>	                          		
	                          		
	                          		<div class="col-md-2">
		                          		<div class="form-group">
                                           <label class="control-label">[(#{txt.total.comprobante})]</label>
                                           <input readonly="readonly" th:field="*{totalFactura}" class="form-control">
                                        </div>
	                          		</div>
		  						</div>
	
                           </form>
                    	
                    </div>
                </div>
            </div>
            
            
        <!-- ============================================================== -->
        <!-- End PAge Content -->
        <!-- ============================================================== -->
    </div>
    <!-- ============================================================== -->
    <!-- End Container fluid  -->
    <!-- ============================================================== -->
    <!-- ============================================================== -->
    <!-- footer -->
    <!-- ============================================================== -->
    <footer th:replace="layout/layout :: footer"></footer>
    <!-- ============================================================== -->
    <!-- End footer -->
    <!-- ============================================================== -->
    <input id="csrfToken" type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
</div>
<!-- ============================================================== -->
<!-- End Page wrapper  -->
<!-- ============================================================== -->

</div>
<div th:replace="layout/layout :: scripts"></div>
<script type="text/javascript">
var token = $('#csrfToken').val();

$("#formAddMensajeReceptor").submit(function( event ) {
	  $.ajax({
        type: "POST",
        cache: false,
        beforeSend: function () {},
        url: "[(@{/mensaje-receptor/recepcion})]",
        data: $(this).serialize(),
        success: function (data)
        {
        	
        	if(parseInt(data.response) === 202){
        		
        		swal("", "El documento ha sido recibido con éxito, clave: "+data.clave+", consecutivo: "+data.consecutivo+".", "success");
        		
        	}else if(parseInt(data.response) === 0){
        		location.href="[(@{/})]"	
        	}else{
        		alert("La identificación del cliente o el correo 1 ya existen, debe cambiarlo");
        	}   
        	
        }, complete: function () {
            //loading_hide();
        }, error: function (x, t, m) {
            if (t === "timeout") {
                
            } else {
                
            }
        }
    });
	  
	return false;  
});


function readXml(event, out) {
	var input = event.target;
	var reader = new FileReader();
	reader.onload = function () {
	    var text = reader.result;
	    var node = document.getElementById(out);
	    //node.innerText = text;
	    var $xml;
	    var xml = text,
	    xmlDoc = $.parseXML(xml),
	    $xml = $(xmlDoc);
	    var Clave = $xml.find("Clave");
	    var TotalComprobante = $xml.find("TotalComprobante");
	    var FechaEmision = $xml.find("FechaEmision");
	    var CodigoMoneda = $xml.find("CodigoMoneda");
	    var emisorNombre = $xml.find("Emisor Nombre");
	    var emisorNumero = $xml.find("Emisor Numero");
	    var tipoCedulaEmisor = $xml.find("Emisor Identificacion Tipo");
	    var emisorNombreComercial = $xml.find("Emisor NombreComercial");
	    var existeImpuesto = $xml.find("TotalImpuesto");
	    var CorreoElectronico = $xml.find("Emisor CorreoElectronico");
	    var nombreReceptor = $xml.find("Receptor Nombre");
	    var nombreComercialReceptor = $xml.find("Receptor NombreComercial");
	    var tipoCedulaReceptor = $xml.find("Receptor Identificacion Tipo");
	    var cedulaReceptor = $xml.find("Receptor Identificacion Numero");
	    $("#totalFactura").val(TotalComprobante.text());
	    $("#impuestos").val(existeImpuesto.text());
	    $("#clave").val(Clave.text());
	    $("#fechaEmision").val(FechaEmision.text());
	    $("#moneda").val(CodigoMoneda.text());
	    $("#emisorMr").val(emisorNombre.text());
	    $("#identificacionEmisorMr").val(emisorNumero.text());
	    $("#nombreComercialEmisorMr").val(emisorNombreComercial.text());
	    $("#correoEmisorMr").val(CorreoElectronico.text());
	    $("#tipoIdentificacionEmisorMr").val(tipoCedulaEmisor.text());
	    $("#nombreReceptorMr").val(nombreReceptor.text());
	    $("#nombreComercialReceptorMr").val(nombreComercialReceptor.text());
	    $("#tipoIdentificacionReceptorMr").val(tipoCedulaReceptor.text());
	    $("#identificacionReceptorMr").val(cedulaReceptor.text());
	};
	reader.readAsText(input.files[0]);
}

$(document).on("input", ".search-products", function(){
	
	var idLinea = $(this).attr("data-id");
	$("#i-codigo-id-"+idLinea).autocomplete({
		
	 	source : function(request, response) {
	 		
	 		$.ajax({
	 			url: "[(@{/proformas/buscar-productos/})]" + request.term,
	 			dataType : "json",
	 			beforeSend: function () {
	              	 loadingShow();
	            },
	            data : {
	 				term : request.term
	 			},
	 			success : function(data) {
	 				response($.map(data, function(item) {
	 					return { 
	 						value: 'Código: ' + item.codigo + ', ' + item.nombreProducto,
	                        codigoInterno: item.id,
	                        codigo: item.codigo,
	                        label: 'Código: ' + item.codigo + ',' + item.nombreProducto,
	                        
	                        idLinea: idLinea,
	                        precioPromediado: parseFloat(item.precioPromediado),
	                        precioActual: parseFloat(item.precio),
	                        inventarioActual: parseFloat(item.inventarioActual),
	                        utilidad: parseFloat(item.utilidad),
	                        utilidadFraccion: item.utilidadFraccion,
	                        
	                        precioFraccion: parseFloat(item.precioFraccion),
                            fraccionesPorUnidad: item.fraccionesPorUnidad,
                         	tipoVenta: item.tipoVenta,
	 					};
	 				}));
	 			},
	 			complete: function () {
	           	 loadingHide();
	            }
	 		});
	 	},
	 	autoFocus:true,
	 	delay:250,
	 	focus : function(event, ui) {
	 		event.preventDefault();

	 		$("#h-codigo-id-"   + ui.item.idLinea).val(ui.item.codigoInterno);
	 		$("#i-utilidad-id-"   + ui.item.idLinea).val(ui.item.utilidad);
	 		$("#i-utilidad-f-id-" + ui.item.idLinea).val(ui.item.utilidadFraccion);	 		
	 		$("#i-tipo-venta-id-" + ui.item.idLinea).val(ui.item.tipoVenta);
	 		$("#i-fracciones-unidad-id-" + ui.item.idLinea).val(ui.item.fraccionesPorUnidad);	 		
	 		$("#i-precio-actual-sin-iva-id-" + ui.item.idLinea).val(ui.item.precioActual);
	 		$("#i-precio-venta-fraccion-sin-iva-id-" + ui.item.idLinea).val(ui.item.precioFraccion);
 
	 		calculaPrecios(ui.item.idLinea);
	 		
	 	}
	 	
	 });
	
});

function aplicaOmiteDescuento(idLinea){	
	
	var precioVentaSinIva = $("#i-precio-venta-sin-iva-id-" + idLinea).val();
	
	if ($("#i-aplica-desc-linea-id-" + idLinea).prop('checked')) {
		
		$("#i-monto-total-linea-aplicar-" + idLinea).val(   $("#i-sub-total-" + idLinea).val()  );
		
		calculaPrecios(idLinea);
		
	}else{
		$("#i-monto-total-linea-aplicar-" + idLinea).val(   $("#i-monto-total-" + idLinea).val()  );
		
		calculaPrecios(idLinea);
	}	
}

function calculaPrecios(idLinea){

	var utilidad = $("#i-utilidad-id-"   + idLinea).val();
	var utilidadFraccion = $("#i-utilidad-f-id-"   + idLinea).val();

	var cantidad            = $("#i-cantidad-id-"   + idLinea).val();
	var montoTotal          = $("#i-monto-total-linea-aplicar-" + idLinea).val();
	var totalImpuestos      = $("#i-total-impuestos-id-"   + idLinea).val();
	var fraccionesPorUnidad = $("#i-fracciones-unidad-id-" + idLinea).val();

	_montoTotal = parseFloat(montoTotal) + parseFloat(totalImpuestos);
	precioCompra = _montoTotal / cantidad;
	_precioVentaFinal = parseFloat( precioCompra + ((precioCompra * utilidad) / 100) );

	$("#i-precio-compra-" + idLinea).val(precioCompra);

	//Precio unidad
	var precioFraccion = parseFloat((_precioVentaFinal / fraccionesPorUnidad));

	//Precio fracción
	var _precioFraccionFinal = 0;
	var precioFraccionFinal = parseFloat( precioFraccion + ((precioFraccion * utilidadFraccion) / 100) );
	if(isNaN(precioFraccionFinal)){
	    _precioFraccionFinal = 0;
	}else{
	    _precioFraccionFinal = precioFraccionFinal;
	}

	//Precio venta sin iva unidad
	$("#i-precio-venta-sin-iva-id-"   + idLinea).val( _precioVentaFinal );

	//Precio venta sin iva fracción
	$("#i-precio-venta-fraccion-sin-iva-id-"   + idLinea).val( _precioFraccionFinal );
}

function readOnly(id){
	$("#i-codigo-id-" + id).prop("readonly",true);
	$("#i-utilidad-id-" + id).prop("readonly",true);
	$("#i-utilidad-f-id-" + id).prop("readonly",true);
	$("#i-precio-venta-sin-iva-id-" + id).prop("readonly",true);
	$("#i-precio-venta-fraccion-sin-iva-id-" + id).prop("readonly",true);
}

$(document).on("click", ".btn-aplicar-linea", function(e){
	
	var id = $(this).attr("data-id");
	var _pasiv      = $("#i-precio-actual-sin-iva-id-"   + id).val();
	var _pc         = $("#i-precio-compra-"   + id).val();
	var _ppro       = 0; //Precio promediado
	var _pv         = $("#i-precio-venta-sin-iva-id-" + id).val(); //Precio venta
	var _cantidad   = $("#i-cantidad-id-" + id).val(); //Cantidad de productos
	var _utilidad   = $("#i-utilidad-id-"   + id).val();
	var _utilidadF  = $("#i-utilidad-f-id-" + id).val();	
	var _pvf        = $("#i-precio-venta-fraccion-sin-iva-id-" + id).val();
	var _ci         = $("#h-codigo-id-" + id).val();
	var _fpu 		= $("#i-fracciones-unidad-id-" + id).val();

	 $.ajax({
	        type: "POST",
	        cache: false,
	        beforeSend: function () {
	            loadingShow();
	            $("#btn-aplicar-linea"+id).prop("disabled", true);
	        },
	        url: "[(@{/mensaje-receptor/aplicar-inventario})]",
	        data: { _csrf:token, pc:_pc, ppro:_ppro, pv:_pv, cantidad:_cantidad, utilidad:_utilidad, utilidadF:_utilidadF, pvf:_pvf, ci:_ci, id:id, fpu:_fpu, pasiv:_pasiv },
	        success: function (data)
	        {

	        if(parseInt(data.response) === 200){

	             notificacion('Inventario aplicado con éxito');
	            
	            $("#btn-aplicar-linea"+id).remove();
	            
	            $("#i-aplica-desc-linea-id-"+id).remove();

	            $("#row-"+id).addClass("table-success");
	            
	            readOnly(id);
	            
	        }else{
	            swal("Notificación", "¡Ocurrió un error, contacte al desarrollador!", "warning");
	        }
	            
	        }, complete: function () {
	            loadingHide();
	        	$("#btn-aplicar-linea"+id).remove();
	        }, error: function (x, t, m) {
	            if (t === "timeout") {
	                
	            } else {
	                
	            }
	        }
	    });
		
	return false;
	
});

function calculaPrecioFraccion(id){
	//Precio de venta fracción
	var utilidadDecimal = 0.00;
    try{
    	var utilidadFraccion = $("#i-utilidad-f-id-" + id).val();
    	if(utilidadFraccion >= 10){
    		utilidadDecimal = parseFloat('1.'+utilidadFraccion);
    	}else{
    		utilidadDecimal = parseFloat('0.0'+utilidadFraccion);
    	}
    	
    }catch(error){
    	utilidadDecimal = utilidadDecimal;
    }
    
    var precioFraccion =  parseFloat($("#i-precio-venta-sin-iva-id-" + id).val()) / parseFloat($("#i-fracciones-unidad-id-" + id).val());
    var precioFraccionFinal = parseFloat( precioFraccion + ((precioFraccion * utilidadFraccion) / 100) );
    
    $("#i-precio-venta-fraccion-sin-iva-id-" + id).val( precioFraccionFinal );

}

$(document).on("input", ".calcula-precio-final", function(){

	var id = $(this).attr("data-l");    	

	var utilidad         = $(this).val();
	var utilidadFraccion = $("#i-utilidad-f-id-"      + id).val();	
	var cantidad         = $("#i-cantidad-id-"        + id).val();
	var montoTotal       = $("#i-monto-total-linea-aplicar-"        + id).val();
	var totalImpuestos   = $("#i-total-impuestos-id-" + id).val();

	_montoTotal = parseFloat(montoTotal) + parseFloat(totalImpuestos);
	precioCompra = _montoTotal / cantidad;
	_precioVentaFinal = parseFloat( precioCompra + ((precioCompra * utilidad) / 100) );

	$("#i-precio-venta-sin-iva-id-" + id).val( _precioVentaFinal );

	//Precio de venta fracción
	calculaPrecioFraccion(id);
	
});

$(document).on("input", ".calcula-utilidad", function(){
	
	var id = parseInt($(this).attr("data-l"));    	
	
	calculaUtilidad(id, $(this).val());

});

function calculaUtilidad(idLinea, valorActual){
	
	var id = idLinea;    	
	
	var cantidad         = $("#i-cantidad-id-"        + id).val();
	var montoTotal       = $("#i-monto-total-linea-aplicar-"        + id).val();
	var totalImpuestos   = $("#i-total-impuestos-id-" + id).val();  
	
	_montoTotal = parseFloat(montoTotal) + parseFloat(totalImpuestos);
	precioCompra = _montoTotal / cantidad;

	var venta = valorActual;	
	var f = parseFloat( ( (venta - precioCompra) / precioCompra) * 100 );

	$("#i-utilidad-id-" + id).val( f );
	
	calculaPrecioFraccion(id);	

}

$(document).on("input", ".calcula-precio-fraccion", function(){
	
	var id= $(this).attr("data-l");
	var util = $(this).val();
	
	var utilidadDecimal = 0.00;
    try{
    	utilidadDecimal = parseFloat(util);
    }catch(error){
    	utilidadDecimal = utilidadDecimal;
    }
    
    var precioFraccion =  parseFloat($("#i-precio-venta-sin-iva-id-" + id).val()) / parseFloat($("#i-fracciones-unidad-id-" + id).val());
    var precioFraccionFinal = parseFloat( precioFraccion + ((precioFraccion * utilidadDecimal) / 100) );

    $("#i-precio-venta-fraccion-sin-iva-id-" + id).val( precioFraccionFinal );

});


$(document).on("input", ".calcula-utilidad-fraccion", function(){
	
	var id= $(this).attr("data-l");
	var util = $(this).val();
	
	var pc = parseFloat( $("#i-precio-venta-sin-iva-id-" + id).val() ) / parseFloat( $("#i-fracciones-unidad-id-" + id).val() );
	var pv  = parseFloat( $(this).val() );
	var f = parseFloat( ( (pv - pc) / pc) * 100 );

	$("#i-utilidad-f-id-" + id).val( f );

});


 $(document).on("click", "#btnFinalizaFactura", function(e){
		
		var id = $(this).attr("data-id");

		 $.ajax({
		        type: "POST",
		        cache: false,
		        beforeSend: function () {
		            loadingShow();
		            $("#btn-aplicar-linea"+id).prop("disabled", true);
		        },
		        url: "[(@{/mensaje-receptor/aplicar-factura})]",
		        data: { _csrf:token, id:id },
		        success: function (data)
		        {

		        if(parseInt(data.response) === 200){

		            notificacion('Factura aplicada con éxito con éxito');
		            
		            $(this).remove();
		            
		        }else{
		            swal("Notificación", "¡Ocurrió un error, contacte al desarrollador!", "warning");
		        }
		            
		        }, complete: function () {
		            loadingHide();
		        }, error: function (x, t, m) {
		            if (t === "timeout") {
		                
		            } else {
		                
		            }
		        }
		    });
			
		return false;
		
	});
</script>



</body>
</html>